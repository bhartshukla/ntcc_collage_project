<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Farmer Friend Â· Rice Fertilizer Advice</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    .progress-bar { height: 8px; border-radius: 4px; transition: width .5s ease-in-out; }
    .disease-row:hover { background-color: #f0fdf4; }
    .dots::after { content: ""; display: inline-block; width: 0.8em; text-align: left; animation: dots 1s steps(5,end) infinite; }
    @keyframes dots { 0% { content: ""; } 20% { content: "."; } 40% { content: ".."; } 60% { content: "..."; } 80% { content: "...."; } 100% { content: ""; } }
    .fade-in { opacity: 0; transform: translateY(6px); transition: opacity .45s ease, transform .45s ease; }
    .fade-in.show { opacity: 1; transform: translateY(0); }
    canvas { width: 100% !important; height: auto !important; }
    .status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    .status-deficient { background-color: #fee2e2; color: #991b1b; }
    .status-optimal { background-color: #dcfce7; color: #166534; }
    .status-excess { background-color: #fef9c3; color: #854d0e; }
    .simple-english { font-size: 0.95rem; line-height: 1.5; }
  </style>
</head>
<body class="bg-gray-50 text-slate-800">

<div class="container mx-auto px-4 py-8">
  <header class="mb-6 text-center">
    <h1 class="text-3xl font-bold text-green-800 mb-1">ğŸŒ¾ Farmer Friend Â· Rice Fertilizer Advice</h1>
    <p class="text-gray-600 simple-english">Tell us about your field and get scientific fertilizer recommendations</p>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- INPUT PANEL Â· Tell us about your field -->
    <div class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold text-green-700 mb-4">ğŸ“‹ Your Field Details</h2>
      <form id="cropForm" class="space-y-4" onsubmit="return false;">
        <div>
          <label class="text-sm font-medium text-gray-700">District name</label>
          <select id="district" class="w-full mt-1 px-3 py-2 border rounded-md">
            <option value="">-- choose district --</option>
            <option>Lucknow</option><option>Agra</option><option>Gorakhpur</option><option>Varanasi</option><option>Jhansi</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Soil type</label>
          <select id="soilTexture" class="w-full mt-1 px-3 py-2 border rounded-md">
            <option value="">-- choose soil type --</option>
            <option>Clay Loam</option><option>Silty Clay Loam</option><option>Silty Loam</option><option>Clay</option>
          </select>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><label class="text-sm">Soil pH</label><input id="soilPh" step="0.1" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">good range: 6.0â€“6.8</p></div>
          <div><label class="text-sm">Soil moisture (%)</label><input id="soilMoisture" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">good: 70â€“80%</p></div>
          <div><label class="text-sm">Nitrogen (N) kg/ha</label><input id="nitrogen" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">good: 120â€“150</p></div>
          <div><label class="text-sm">Phosphorus (P) kg/ha</label><input id="phosphorus" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">good: 40â€“60</p></div>
          <div><label class="text-sm">Potassium (K) kg/ha</label><input id="potassium" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">good: 40â€“60</p></div>
          <div><label class="text-sm">Temperature (Â°C)</label><input id="temperature" step="0.1" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">good: 28â€“32Â°C</p></div>
          <div><label class="text-sm">Humidity (%)</label><input id="humidity" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">good: 65â€“85%</p></div>
          <div><label class="text-sm">Rainfall (mm)</label><input id="rainfall" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">good: 1000â€“1200 mm</p></div>
        </div>
        <div class="flex gap-2">
          <button type="button" id="resetBtn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300"><i class="fas fa-redo mr-2"></i>Reset</button>
          <button type="button" id="calculateBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"><i class="fas fa-calculator mr-2"></i>Calculate</button>
        </div>
      </form>
    </div>

    <!-- RESULTS Â· Your field report -->
    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-green-700">ğŸ“Š Your Field Report</h2>
        <button id="diseaseBtn" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-md"><i class="fas fa-bug mr-1"></i>Disease info</button>
      </div>
      <button id="downloadImageBtn" class="mb-3 px-3 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-md"><i class="fas fa-download mr-2"></i>Download report as image</button>

      <div id="resultsContainer" class="space-y-4">
        <div id="placeholderIntro" class="text-center py-8 text-gray-400"><i class="fas fa-leaf text-4xl mb-2"></i><p class="simple-english">Fill all details and click Calculate</p></div>
        <div id="warningBox" class="hidden bg-red-100 border border-red-200 text-red-800 p-3 rounded-lg flex gap-2 items-center"><i class="fas fa-triangle-exclamation"></i><span id="warningText" class="simple-english">Please fill all fields</span></div>
        <div id="loaderArea" class="hidden p-4 bg-white rounded-lg border"><div class="flex items-center gap-3"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div><div><div class="font-medium">Analyzing your field<span class="dots"></span></div><div class="text-xs text-gray-500">Just a moment...</div></div></div></div>

        <!-- final results -->
        <div id="finalResults" class="fade-in hidden space-y-4">
          <div class="bg-green-50 p-4 rounded-lg"><div class="flex justify-between"><h3 class="font-medium text-green-800">ğŸŒ± Crop growth score</h3><span id="growthScoreLabel" class="text-xl font-bold text-green-700">0/100</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="growthBar" class="progress-bar bg-green-600 h-2.5 rounded-full" style="width:0%"></div></div></div>
          
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-blue-50 p-4 rounded-lg"><h3 class="font-medium text-blue-800">âš–ï¸ Expected yield</h3><p id="expectedYieldLabel" class="text-2xl font-bold text-blue-700">â€” kg/ha</p></div>
            <div class="bg-purple-50 p-4 rounded-lg"><h3 class="font-medium text-purple-800">âš ï¸ Disease risk</h3><p id="diseaseRiskLabel" class="text-2xl font-bold text-red-600">â€”</p><p id="riskScoreLabel" class="text-xs text-gray-600">risk score 0%</p></div>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-yellow-50 p-4 rounded-lg"><h3 class="font-medium text-yellow-800">ğŸ§ª Soil suitability</h3><div class="flex items-center"><span id="soilScoreLabel" class="text-2xl font-bold text-yellow-700 mr-2">0%</span><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="soilBar" class="progress-bar bg-yellow-500 h-2.5 rounded-full" style="width:0%"></div></div></div></div>
            <div class="bg-indigo-50 p-4 rounded-lg"><h3 class="font-medium text-indigo-800">â˜ï¸ Weather suitability</h3><div class="flex items-center"><span id="weatherScoreLabel" class="text-2xl font-bold text-indigo-700 mr-2">0%</span><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="weatherBar" class="progress-bar bg-indigo-500 h-2.5 rounded-full" style="width:0%"></div></div></div></div>
          </div>
          
          <div class="bg-gray-50 p-4 rounded-lg"><h3 class="font-medium text-gray-800">ğŸ“ Summary</h3><p id="matchSummaryLabel" class="text-lg font-semibold text-gray-800 simple-english">â€”</p></div>
          
          <!-- FERTILIZER RECOMMENDATION in simple English -->
          <div class="bg-white border-2 border-green-200 p-4 rounded-lg">
            <div class="flex justify-between items-center mb-3">
              <h3 class="font-bold text-green-800">ğŸ§ª Fertilizer advice for your field</h3>
              <button id="viewDetailsBtn" class="text-xs bg-green-600 text-white px-3 py-1 rounded-full hover:bg-green-700">How we calculate</button>
            </div>
            
            <!-- Status badges -->
            <div class="grid grid-cols-3 gap-2 mb-4">
              <div class="text-center">
                <span class="text-sm font-medium">Nitrogen (N)</span>
                <div><span id="nStatusBadge" class="status-badge">â€”</span></div>
              </div>
              <div class="text-center">
                <span class="text-sm font-medium">Phosphorus (P)</span>
                <div><span id="pStatusBadge" class="status-badge">â€”</span></div>
              </div>
              <div class="text-center">
                <span class="text-sm font-medium">Potassium (K)</span>
                <div><span id="kStatusBadge" class="status-badge">â€”</span></div>
              </div>
            </div>
            
            <!-- Fertilizer doses -->
            <div class="grid grid-cols-3 gap-3 mb-4">
              <div class="bg-blue-50 p-2 rounded text-center">
                <div class="text-xs text-gray-600">Urea (kg per hectare)</div>
                <div class="text-xl font-bold text-blue-700" id="ureaDose">0</div>
              </div>
              <div class="bg-purple-50 p-2 rounded text-center">
                <div class="text-xs text-gray-600">DAP (kg per hectare)</div>
                <div class="text-xl font-bold text-purple-700" id="dapDose">0</div>
              </div>
              <div class="bg-amber-50 p-2 rounded text-center">
                <div class="text-xs text-gray-600">MOP (kg per hectare)</div>
                <div class="text-xl font-bold text-amber-700" id="mopDose">0</div>
              </div>
            </div>
            
            <!-- How to apply Â· simple English -->
            <div class="space-y-2 text-sm">
              <div class="bg-green-50 p-2 rounded">
                <span class="font-semibold">Nitrogen:</span> <span id="nitrogenMethodText" class="simple-english">â€”</span>
              </div>
              <div class="bg-green-50 p-2 rounded">
                <span class="font-semibold">Phosphorus:</span> <span id="phosphorusMethodText" class="simple-english">â€”</span>
              </div>
              <div class="bg-green-50 p-2 rounded">
                <span class="font-semibold">Potassium:</span> <span id="potassiumMethodText" class="simple-english">â€”</span>
              </div>
            </div>
            
            <!-- Warnings -->
            <div id="fertilizerWarnings" class="mt-3 space-y-1"></div>
          </div>

          <!-- charts -->
          <div class="bg-white p-3 rounded-lg border"><canvas id="compareChart" height="140"></canvas></div>
          <div class="bg-white p-3 rounded-lg border"><canvas id="npkChart" height="110"></canvas></div>
          <div class="bg-white p-3 rounded-lg border"><canvas id="fertBChart" height="110"></canvas></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Disease modal -->
<div id="diseaseModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4 z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-auto p-6">
    <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-green-800">ğŸŒ¾ Rice diseases and how to prevent</h3><button id="closeModal" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button></div>
    <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500">Disease</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500">What causes it</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500">Symptoms</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500">How to prevent</th></tr></thead><tbody id="diseaseTbody"></tbody></table>
  </div>
</div>

<!-- How we calculate modal -->
<div id="fertilizerModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4 z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-auto p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold text-green-800">How we calculate your fertilizer</h3>
      <button id="closeFertilizerModal" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
    </div>
    <div id="fertilizerDetails" class="space-y-4 simple-english"></div>
  </div>
</div>

<script>
(function() {
  // ========================================================
  // SCIENTIFIC FERTILIZER MODEL Â· Simple English version
  // ========================================================
  
  function calculateRiceFertilizer(N, P, K) {
    // Ideal amounts for rice
    const ideals = {
      N: { min: 120, max: 150, ideal: 135, sigma: 25, baseDose: 80, maintDose: 20 },
      P: { min: 40, max: 60, ideal: 50, sigma: 12, baseDose: 60, maintDose: 20 },
      K: { min: 40, max: 60, ideal: 50, sigma: 12, baseDose: 50, maintDose: 20 }
    };

    // Convert nutrient to fertilizer
    // Urea has 46% N, DAP has 46% P2O5, MOP has 60% K2O
    const conversion = {
      NtoUrea: 2.17,  // 1 kg N needs 2.17 kg Urea
      PtoDAP: 2.17,   // 1 kg P needs 2.17 kg DAP
      KtoMOP: 1.67    // 1 kg K needs 1.67 kg MOP
    };

    let warnings = [];
    let result = {
      nitrogenStatus: "",
      phosphorusStatus: "",
      potassiumStatus: "",
      ureaKgPerHa: 0,
      dapKgPerHa: 0,
      mopKgPerHa: 0,
      applicationMethod: {
        nitrogen: "",
        phosphorus: "",
        potassium: ""
      },
      warnings: warnings
    };

    // Gaussian function to calculate how suitable the nutrient level is
    function calculateSuitability(value, ideal, sigma) {
      const diff = value - ideal;
      return Math.exp(-(diff * diff) / (2 * sigma * sigma));
    }

    // Calculate for N, P and K
    ['N', 'P', 'K'].forEach(nutrient => {
      const value = nutrient === 'N' ? N : (nutrient === 'P' ? P : K);
      const config = ideals[nutrient];
      
      // How suitable is this value? (1 = perfect, 0 = very bad)
      const suitability = calculateSuitability(value, config.ideal, config.sigma);
      // How much deficiency? (1 - suitability)
      const deficiency = 1 - suitability;
      
      // Decide if nutrient is low, good or high
      let status;
      if (value < config.min) status = "Deficient";      // too low
      else if (value > config.max) status = "Excess";    // too high
      else status = "Optimal";                            // just right
      
      // Save status
      if (nutrient === 'N') result.nitrogenStatus = status;
      else if (nutrient === 'P') result.phosphorusStatus = status;
      else if (nutrient === 'K') result.potassiumStatus = status;
      
      // Calculate how much nutrient to add (kg/ha)
      let nutrientDose = 0;
      
      if (value < config.ideal) {
        // If nutrient is low: dose = baseDose Ã— (deficiency ^ 1.5)
        // The power 1.5 means: if deficiency is high, dose increases faster
        nutrientDose = config.baseDose * Math.pow(deficiency, 1.5);
        
        // Special rule for very low potassium
        if (nutrient === 'K' && value < 35) {
          nutrientDose = nutrientDose * 1.1; // add 10% more
          warnings.push("âš ï¸ Potassium is very low. Add 10% extra MOP to prevent lodging and brown spot.");
        }
        
        // Round to nearest whole number
        nutrientDose = Math.round(nutrientDose);
        if (nutrientDose < 20) nutrientDose = 20; // always add at least 20 kg
        
      } else if (value <= config.max) {
        // If nutrient is just right, add small maintenance dose
        nutrientDose = config.maintDose;
      } else {
        // If nutrient is too high, add nothing and give warning
        nutrientDose = 0;
        if (nutrient === 'N' && value > 160) {
          warnings.push("âš ï¸ Nitrogen is too high. Do not add urea. High N increases blast disease risk.");
        } else if (nutrient === 'N') {
          warnings.push("âš ï¸ Nitrogen is high. Too much N can cause diseases and lodging.");
        } else if (nutrient === 'P') {
          warnings.push("âš ï¸ Phosphorus is high. Too much P can cause zinc deficiency.");
        } else if (nutrient === 'K') {
          warnings.push("âš ï¸ Potassium is high. Too much K can reduce magnesium uptake.");
        }
      }
      
      // Convert nutrient dose to fertilizer amount and give application advice
      if (nutrient === 'N') {
        result.ureaKgPerHa = Math.round(nutrientDose * conversion.NtoUrea);
        if (status === "Deficient") {
          result.applicationMethod.nitrogen = 
            "Split into three parts: 50% before planting, 25% at tillering (20-25 days), 25% at panicle initiation (50-55 days)";
        } else if (status === "Optimal") {
          result.applicationMethod.nitrogen = "Add small maintenance dose at tillering stage";
        } else {
          result.applicationMethod.nitrogen = "Do not add any nitrogen fertilizer";
        }
      } else if (nutrient === 'P') {
        result.dapKgPerHa = Math.round(nutrientDose * conversion.PtoDAP);
        if (status === "Deficient") {
          result.applicationMethod.phosphorus = "Apply all at one time before planting. Mix well in soil.";
        } else if (status === "Optimal") {
          result.applicationMethod.phosphorus = "Add small maintenance dose before planting";
        } else {
          result.applicationMethod.phosphorus = "Do not add any phosphorus fertilizer";
        }
      } else if (nutrient === 'K') {
        result.mopKgPerHa = Math.round(nutrientDose * conversion.KtoMOP);
        if (status === "Deficient") {
          result.applicationMethod.potassium = "Split into two parts: 50% before planting, 50% at panicle initiation";
        } else if (status === "Optimal") {
          result.applicationMethod.potassium = "Add small maintenance dose before planting";
        } else {
          result.applicationMethod.potassium = "Do not add any potassium fertilizer";
        }
      }
    });

    return result;
  }

  // ========================================================
  // DISTRICT DATA AND OTHER FUNCTIONS
  // ========================================================
  const districtData = [
    { district: "Lucknow", pH: 6.9, moisture: 72, nitrogen: 198, phosphorus: 20, potassium: 174, temperature: 29.5, humidity: 78, rainfall: 920 },
    { district: "Agra", pH: 6.3, moisture: 65, nitrogen: 190, phosphorus: 18, potassium: 180, temperature: 30.8, humidity: 70, rainfall: 890 },
    { district: "Gorakhpur", pH: 6.6, moisture: 78, nitrogen: 220, phosphorus: 26, potassium: 165, temperature: 28.5, humidity: 84, rainfall: 1150 },
    { district: "Varanasi", pH: 6.0, moisture: 68, nitrogen: 130, phosphorus: 27, potassium: 229, temperature: 30.2, humidity: 80, rainfall: 960 },
    { district: "Jhansi", pH: 7.06, moisture: 64, nitrogen: 178, phosphorus: 8.5, potassium: 189, temperature: 31.2, humidity: 68, rainfall: 885 }
  ];

  const soilTextureRatings = { "Clay Loam": 5, "Silty Clay Loam": 4.5, "Silty Loam": 4, "Clay": 3 };

  const diseaseData = [ 
    { "name": "Blast Disease", "triggers": "Too much Nitrogen (>160), High humidity (>85%), Wet soil", "symptoms": "Gray diamond-shaped spots", "prevention": "Reduce nitrogen, plant with space, use resistant varieties" },
    { "name": "Bacterial Leaf Blight", "triggers": "Very high humidity (>90%), Heavy rain (>1200 mm)", "symptoms": "Leaf tips turn yellow", "prevention": "Use clean seeds, manage water carefully" },
    { "name": "Sheath Blight", "triggers": "High Nitrogen (>150), Wet soil (>85%), Dense planting", "symptoms": "Rot on lower part of stem", "prevention": "Use less nitrogen, give more space between plants" },
    { "name": "Brown Spot", "triggers": "Low Potassium (<40), Low Phosphorus (<40), Less rain", "symptoms": "Brown spots with yellow ring", "prevention": "Add potassium and phosphorus, irrigate properly" },
    { "name": "Tungro Virus", "triggers": "High humidity, Late planting", "symptoms": "Leaves turn orange-yellow, stunted growth", "prevention": "Plant early, control insects" },
    { "name": "Stem Rot", "triggers": "Same field every year, too much nitrogen", "symptoms": "Hollow stems, rot at base", "prevention": "Rotate crops, balance nitrogen" },
    { "name": "False Smut", "triggers": "High humidity + rain during flowering, excess nitrogen", "symptoms": "Green smut balls on grains", "prevention": "Remove infected grains, reduce nitrogen" },
    { "name": "Leaf Scald", "triggers": "Too much nitrogen, high humidity", "symptoms": "Brown water-soaked lesions", "prevention": "Split nitrogen into multiple doses" },
    { "name": "Narrow Brown Spot", "triggers": "Low Potassium (<40), Too much nitrogen", "symptoms": "Narrow brown spots", "prevention": "Add potassium fertilizer, reduce nitrogen" }
  ];

  // DOM elements
  const districtEl = document.getElementById('district');
  const soilPh = document.getElementById('soilPh'), soilMoisture = document.getElementById('soilMoisture'), soilTexture = document.getElementById('soilTexture');
  const nitrogen = document.getElementById('nitrogen'), phosphorus = document.getElementById('phosphorus'), potassium = document.getElementById('potassium');
  const temperature = document.getElementById('temperature'), humidity = document.getElementById('humidity'), rainfall = document.getElementById('rainfall');
  const calcBtn = document.getElementById('calculateBtn'), resetBtn = document.getElementById('resetBtn');
  const loader = document.getElementById('loaderArea'), finalDiv = document.getElementById('finalResults'), placeholder = document.getElementById('placeholderIntro'), warnBox = document.getElementById('warningBox'), warnText = document.getElementById('warningText');
  
  // Result labels
  const growthLbl = document.getElementById('growthScoreLabel'), growthBar = document.getElementById('growthBar');
  const yieldLbl = document.getElementById('expectedYieldLabel');
  const diseaseLbl = document.getElementById('diseaseRiskLabel'), riskScoreLbl = document.getElementById('riskScoreLabel');
  const soilScoreLbl = document.getElementById('soilScoreLabel'), soilBar = document.getElementById('soilBar');
  const weatherScoreLbl = document.getElementById('weatherScoreLabel'), weatherBar = document.getElementById('weatherBar');
  const summaryLbl = document.getElementById('matchSummaryLabel');
  
  // Fertilizer elements
  const nStatusBadge = document.getElementById('nStatusBadge');
  const pStatusBadge = document.getElementById('pStatusBadge');
  const kStatusBadge = document.getElementById('kStatusBadge');
  const ureaDose = document.getElementById('ureaDose');
  const dapDose = document.getElementById('dapDose');
  const mopDose = document.getElementById('mopDose');
  const nitrogenMethodText = document.getElementById('nitrogenMethodText');
  const phosphorusMethodText = document.getElementById('phosphorusMethodText');
  const potassiumMethodText = document.getElementById('potassiumMethodText');
  const fertilizerWarnings = document.getElementById('fertilizerWarnings');
  
  const viewDetails = document.getElementById('viewDetailsBtn');
  const downloadBtn = document.getElementById('downloadImageBtn');
  const diseaseBtn = document.getElementById('diseaseBtn'), diseaseModal = document.getElementById('diseaseModal'), closeModal = document.getElementById('closeModal');
  const fertModal = document.getElementById('fertilizerModal'), closeFertModal = document.getElementById('closeFertilizerModal'), fertDetails = document.getElementById('fertilizerDetails');
  
  let charts = { compare: null, npk: null, fertB: null };

  // Helper functions
  function softNormalize(value, min, max, ideal) {
    if (isNaN(value) || value === null) return 0;
    const sigma = (max - min) / 4;
    const diff = value - ideal;
    return Math.exp(-(diff * diff) / (2 * sigma * sigma));
  }

  function getTextureScore(texture) {
    return soilTextureRatings[texture] || 0;
  }

  function calculateSoilScore(ph, moisture, texture) {
    const phNorm = softNormalize(ph, 5.5, 7.5, 6.4);
    const moistNorm = softNormalize(moisture, 60, 90, 75);
    const texScore = getTextureScore(texture) / 5;
    return (phNorm * 0.4 + moistNorm * 0.4 + texScore * 0.2) * 100;
  }

  function calculateNutrientScore(N, P, K) {
    const nNorm = softNormalize(N, 80, 200, 135);
    const pNorm = softNormalize(P, 20, 90, 50);
    const kNorm = softNormalize(K, 20, 90, 50);
    return (nNorm * 0.5 + pNorm * 0.25 + kNorm * 0.25) * 100;
  }

  function calculateWeatherScore(temp, hum, rain) {
    const tNorm = softNormalize(temp, 22, 36, 30);
    const hNorm = softNormalize(hum, 55, 95, 75);
    const rNorm = softNormalize(rain, 800, 1500, 1100);
    return (tNorm * 0.4 + hNorm * 0.3 + rNorm * 0.3) * 100;
  }

  function sigmoidGrowth(soilSc, nutrSc, weatherSc) {
    let raw = soilSc * 0.4 + nutrSc * 0.35 + weatherSc * 0.25;
    const k = 0.08, midpoint = 50;
    return 100 / (1 + Math.exp(-k * (raw - midpoint)));
  }

  function logisticYield(finalGrowth) {
    const yMin = 2200, yMax = 3400;
    return yMin + (yMax - yMin) / (1 + Math.exp(-0.1 * (finalGrowth - 60)));
  }

  function computeDiseaseRisk(humidity, nitrogen, soilMoisture, pH) {
    let risk = 0;
    if (humidity > 85) risk += 30;
    if (nitrogen > 160) risk += 30;
    if (soilMoisture > 80) risk += 20;
    if (pH < 5.5 || pH > 7.5) risk += 20;
    risk = Math.min(risk, 100);
    let level = 'Low';
    if (risk > 60) level = 'High';
    else if (risk > 30) level = 'Medium';
    return { level, score: risk };
  }

  function performAnalysis() {
    const ph = parseFloat(soilPh.value) || 0, moist = parseFloat(soilMoisture.value) || 0;
    const texture = soilTexture.value;
    const N = parseFloat(nitrogen.value) || 0, P = parseFloat(phosphorus.value) || 0, K = parseFloat(potassium.value) || 0;
    const temp = parseFloat(temperature.value) || 0, hum = parseFloat(humidity.value) || 0, rain = parseFloat(rainfall.value) || 0;

    const soilSc = calculateSoilScore(ph, moist, texture);
    const nutrSc = calculateNutrientScore(N, P, K);
    const weatherSc = calculateWeatherScore(temp, hum, rain);
    const growth = sigmoidGrowth(soilSc, nutrSc, weatherSc);
    const growthRounded = Math.min(100, Math.max(0, Math.round(growth)));
    const yieldVal = logisticYield(growth);
    const yieldRounded = Math.round(yieldVal);
    const disease = computeDiseaseRisk(hum, N, moist, ph);
    
    let summary = '';
    if (growthRounded >= 75) summary = 'Excellent conditions for rice. Good yield expected.';
    else if (growthRounded >= 55) summary = 'Good conditions. Your field is suitable for rice.';
    else summary = 'Difficult conditions. Check risks and follow advice carefully.';

    // Get fertilizer recommendations
    const fertRec = calculateRiceFertilizer(N, P, K);

    return {
      growth: growthRounded,
      soil: Math.round(soilSc),
      weather: Math.round(weatherSc),
      yield: yieldRounded,
      diseaseLevel: disease.level,
      diseaseScore: disease.score,
      summary,
      N, P, K,
      fertRec
    };
  }

  function renderResults(d) {
    growthLbl.textContent = d.growth + '/100';
    growthBar.style.width = d.growth + '%';
    yieldLbl.textContent = d.yield + ' kg/ha';
    diseaseLbl.textContent = d.diseaseLevel;
    diseaseLbl.className = `text-2xl font-bold ${d.diseaseLevel==='Low'?'text-green-600': d.diseaseLevel==='Medium'?'text-yellow-600':'text-red-600'}`;
    riskScoreLbl.textContent = `risk score ${d.diseaseScore}%`;
    soilScoreLbl.textContent = d.soil + '%'; soilBar.style.width = d.soil + '%';
    weatherScoreLbl.textContent = d.weather + '%'; weatherBar.style.width = d.weather + '%';
    summaryLbl.textContent = d.summary;

    // Update fertilizer
    const f = d.fertRec;
    
    nStatusBadge.textContent = f.nitrogenStatus;
    pStatusBadge.textContent = f.phosphorusStatus;
    kStatusBadge.textContent = f.potassiumStatus;
    
    nStatusBadge.className = `status-badge status-${f.nitrogenStatus.toLowerCase()}`;
    pStatusBadge.className = `status-badge status-${f.phosphorusStatus.toLowerCase()}`;
    kStatusBadge.className = `status-badge status-${f.potassiumStatus.toLowerCase()}`;
    
    ureaDose.textContent = f.ureaKgPerHa;
    dapDose.textContent = f.dapKgPerHa;
    mopDose.textContent = f.mopKgPerHa;
    
    nitrogenMethodText.textContent = f.applicationMethod.nitrogen;
    phosphorusMethodText.textContent = f.applicationMethod.phosphorus;
    potassiumMethodText.textContent = f.applicationMethod.potassium;
    
    fertilizerWarnings.innerHTML = '';
    f.warnings.forEach(w => {
      const warnEl = document.createElement('div');
      warnEl.className = 'text-xs p-2 bg-yellow-50 text-yellow-800 rounded border border-yellow-200 simple-english';
      warnEl.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>${w}`;
      fertilizerWarnings.appendChild(warnEl);
    });

    // Charts
    const ctxComp = document.getElementById('compareChart').getContext('2d');
    if (charts.compare) charts.compare.destroy();
    charts.compare = new Chart(ctxComp, {
      type: 'bar', 
      data: { 
        labels: ['Growth', 'Soil', 'Weather'], 
        datasets: [{ 
          label: 'score', 
          data: [d.growth, d.soil, d.weather], 
          backgroundColor: ['#16a34a','#f59e0b','#0ea5e9'] 
        }]
      },
      options: { 
        responsive: true, 
        plugins: { legend: { display: false } }, 
        scales: { y: { max: 100, beginAtZero: true } } 
      }
    });

    const ctxNpk = document.getElementById('npkChart').getContext('2d');
    if (charts.npk) charts.npk.destroy();
    charts.npk = new Chart(ctxNpk, {
      type: 'bar', 
      data: { 
        labels: ['N', 'P', 'K'], 
        datasets: [{ 
          label: 'kg per hectare', 
          data: [d.N, d.P, d.K], 
          backgroundColor: ['#15803d','#0ea5e9','#7c3aed'] 
        }]
      },
      options: { plugins: { legend: { display: false } } }
    });

    const nDef = Math.round(softNormalize(d.N, 80,200,135)*100);
    const pDef = Math.round(softNormalize(d.P, 20,90,50)*100);
    const kDef = Math.round(softNormalize(d.K, 20,90,50)*100);
    const ctxB = document.getElementById('fertBChart').getContext('2d');
    if (charts.fertB) charts.fertB.destroy();
    charts.fertB = new Chart(ctxB, {
      type: 'bar', 
      data: { 
        labels: ['N fit', 'P fit', 'K fit'], 
        datasets: [{ 
          label: 'suitability %', 
          data: [nDef, pDef, kDef], 
          backgroundColor: ['#16a34a','#0ea5e9','#f59e0b'] 
        }]
      },
      options: { 
        plugins: { legend: { display: false } }, 
        scales: { y: { max:100, beginAtZero: true } } 
      }
    });

    finalDiv.classList.remove('hidden');
    setTimeout(() => finalDiv.classList.add('show'), 20);
  }

  function allFilled() {
    return [districtEl.value, soilTexture.value, soilPh.value, soilMoisture.value, nitrogen.value, phosphorus.value, potassium.value, temperature.value, humidity.value, rainfall.value].every(v => v && v.toString().trim()!=='');
  }

  calcBtn.addEventListener('click', () => {
    warnBox.classList.add('hidden');
    if (!allFilled()) {
      warnText.textContent = 'âš  Please fill all fields (district, soil type and all numbers)';
      warnBox.classList.remove('hidden');
      placeholder.classList.remove('hidden');
      loader.classList.add('hidden');
      finalDiv.classList.add('hidden');
      return;
    }
    placeholder.classList.add('hidden');
    finalDiv.classList.add('hidden');
    loader.classList.remove('hidden');

    setTimeout(() => {
      const res = performAnalysis();
      loader.classList.add('hidden');
      renderResults(res);
    }, 1000);
  });

  districtEl.addEventListener('change', () => {
    const d = districtData.find(x => x.district === districtEl.value);
    if (!d) return;
    soilPh.value = d.pH; soilMoisture.value = d.moisture; nitrogen.value = d.nitrogen;
    phosphorus.value = d.phosphorus; potassium.value = d.potassium;
    temperature.value = d.temperature; humidity.value = d.humidity; rainfall.value = d.rainfall;
    soilTexture.value = '';
  });

  resetBtn.addEventListener('click', () => {
    document.getElementById('cropForm').reset();
    finalDiv.classList.add('hidden'); finalDiv.classList.remove('show');
    loader.classList.add('hidden');
    placeholder.classList.remove('hidden');
    warnBox.classList.add('hidden');
    Object.values(charts).forEach(ch => { if(ch) ch.destroy(); });
    charts = { compare: null, npk: null, fertB: null };
  });

  function populateDiseaseTable() {
    const tbody = document.getElementById('diseaseTbody');
    tbody.innerHTML = '';
    diseaseData.forEach(d => {
      const tr = document.createElement('tr'); tr.className = 'disease-row';
      tr.innerHTML = `<td class="px-6 py-4 font-medium">${d.name}</td><td class="px-6 py-4 text-sm">${d.triggers}</td><td class="px-6 py-4 text-sm">${d.symptoms}</td><td class="px-6 py-4 text-sm">${d.prevention}</td>`;
      tbody.appendChild(tr);
    });
  }
  populateDiseaseTable();
  
  diseaseBtn.addEventListener('click', () => diseaseModal.classList.remove('hidden'));
  closeModal.addEventListener('click', () => diseaseModal.classList.add('hidden'));

  viewDetails.addEventListener('click', () => {
    const N = parseFloat(nitrogen.value) || 0, P = parseFloat(phosphorus.value) || 0, K = parseFloat(potassium.value) || 0;
    const fert = calculateRiceFertilizer(N, P, K);
    
    fertDetails.innerHTML = `
      <div class="bg-blue-50 p-4 rounded-lg">
        <h4 class="font-bold text-lg mb-2">ğŸ“Š Step 1: Calculate nutrient suitability</h4>
        <p class="text-sm mb-1">Nitrogen suitability = ${Math.round(softNormalize(N,80,200,135)*100)}% (100% is perfect)</p>
        <p class="text-sm mb-1">Phosphorus suitability = ${Math.round(softNormalize(P,20,90,50)*100)}%</p>
        <p class="text-sm">Potassium suitability = ${Math.round(softNormalize(K,20,90,50)*100)}%</p>
      </div>
      <div class="bg-green-50 p-4 rounded-lg">
        <h4 class="font-bold text-lg mb-2">ğŸ§ª Step 2: Find deficiency</h4>
        <p class="text-sm mb-1">N deficiency = ${(1 - softNormalize(N,80,200,135)).toFixed(3)}</p>
        <p class="text-sm mb-1">P deficiency = ${(1 - softNormalize(P,20,90,50)).toFixed(3)}</p>
        <p class="text-sm">K deficiency = ${(1 - softNormalize(K,20,90,50)).toFixed(3)}</p>
        <p class="text-xs mt-1">(0 = no deficiency, 1 = completely deficient)</p>
      </div>
      <div class="bg-purple-50 p-4 rounded-lg">
        <h4 class="font-bold text-lg mb-2">âš—ï¸ Step 3: Calculate dose (deficiency raised to power 1.5)</h4>
        <p class="text-sm mb-1">N dose factor = ${Math.pow(1 - softNormalize(N,80,200,135), 1.5).toFixed(3)}</p>
        <p class="text-sm mb-1">P dose factor = ${Math.pow(1 - softNormalize(P,20,90,50), 1.5).toFixed(3)}</p>
        <p class="text-sm">K dose factor = ${Math.pow(1 - softNormalize(K,20,90,50), 1.5).toFixed(3)}</p>
        <p class="text-xs mt-1">This number is multiplied by base dose (80/60/50) to get final recommendation</p>
      </div>
    `;
    fertModal.classList.remove('hidden');
  });

  closeFertModal.addEventListener('click', () => fertModal.classList.add('hidden'));

  downloadBtn.addEventListener('click', () => {
    html2canvas(document.body, { scale: 1.5 }).then(canvas => {
      const link = document.createElement('a');
      link.download = `farmer_friend_${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }).catch(console.warn);
  });
})();
</script>
</body>
</html>