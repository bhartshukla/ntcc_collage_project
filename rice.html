<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CropGuard ¬∑ Rice Analysis with Scientific Fertilizer Model</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    .progress-bar { height: 8px; border-radius: 4px; transition: width .5s ease-in-out; }
    .disease-row:hover { background-color: #f0fdf4; }
    .dots::after { content: ""; display: inline-block; width: 0.8em; text-align: left; animation: dots 1s steps(5,end) infinite; }
    @keyframes dots { 0% { content: ""; } 20% { content: "."; } 40% { content: ".."; } 60% { content: "..."; } 80% { content: "...."; } 100% { content: ""; } }
    .fade-in { opacity: 0; transform: translateY(6px); transition: opacity .45s ease, transform .45s ease; }
    .fade-in.show { opacity: 1; transform: translateY(0); }
    canvas { width: 100% !important; height: auto !important; }
    .status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    .status-deficient { background-color: #fee2e2; color: #991b1b; }
    .status-optimal { background-color: #dcfce7; color: #166534; }
    .status-excess { background-color: #fef9c3; color: #854d0e; }
  </style>
</head>
<body class="bg-gray-50 text-slate-800">

<div class="container mx-auto px-4 py-8">
  <header class="mb-6 text-center">
    <h1 class="text-3xl font-bold text-green-800 mb-1">CropGuard ¬∑ ICAR-Based Fertilizer Model</h1>
    <p class="text-gray-600">Non-linear deficiency analysis for precision rice nutrition</p>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- INPUT PANEL -->
    <div class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold text-green-700 mb-4">Input Parameters</h2>
      <form id="cropForm" class="space-y-4" onsubmit="return false;">
        <div>
          <label class="text-sm font-medium text-gray-700">District</label>
          <select id="district" class="w-full mt-1 px-3 py-2 border rounded-md">
            <option value="">-- select --</option>
            <option>Lucknow</option><option>Agra</option><option>Gorakhpur</option><option>Varanasi</option><option>Jhansi</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Soil texture</label>
          <select id="soilTexture" class="w-full mt-1 px-3 py-2 border rounded-md">
            <option value="">select texture</option>
            <option>Clay Loam</option><option>Silty Clay Loam</option><option>Silty Loam</option><option>Clay</option>
          </select>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><label class="text-sm">Soil pH</label><input id="soilPh" step="0.1" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">ideal 6.0‚Äì6.8</p></div>
          <div><label class="text-sm">Soil moisture (%)</label><input id="soilMoisture" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">ideal 70‚Äì80</p></div>
          <div><label class="text-sm">Nitrogen (N) kg/ha</label><input id="nitrogen" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">ideal 120‚Äì150</p></div>
          <div><label class="text-sm">Phosphorus (P) kg/ha</label><input id="phosphorus" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">ideal 40‚Äì60</p></div>
          <div><label class="text-sm">Potassium (K) kg/ha</label><input id="potassium" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">ideal 40‚Äì60</p></div>
          <div><label class="text-sm">Temperature (¬∞C)</label><input id="temperature" step="0.1" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">ideal 28‚Äì32</p></div>
          <div><label class="text-sm">Humidity (%)</label><input id="humidity" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">ideal 65‚Äì85</p></div>
          <div><label class="text-sm">Rainfall (mm)</label><input id="rainfall" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">ideal 1000‚Äì1200</p></div>
        </div>
        <div class="flex gap-2">
          <button type="button" id="resetBtn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300"><i class="fas fa-redo mr-2"></i>Reset</button>
          <button type="button" id="calculateBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"><i class="fas fa-calculator mr-2"></i>Calculate</button>
        </div>
      </form>
    </div>

    <!-- RESULTS -->
    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-green-700">Analysis Results</h2>
        <button id="diseaseBtn" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-md"><i class="fas fa-bug mr-1"></i>Disease table</button>
      </div>
      <button id="downloadImageBtn" class="mb-3 px-3 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-md"><i class="fas fa-download mr-2"></i>Download full report</button>

      <div id="resultsContainer" class="space-y-4">
        <div id="placeholderIntro" class="text-center py-8 text-gray-400"><i class="fas fa-leaf text-4xl mb-2"></i><p>Fill all fields and calculate</p></div>
        <div id="warningBox" class="hidden bg-red-100 border border-red-200 text-red-800 p-3 rounded-lg flex gap-2 items-center"><i class="fas fa-triangle-exclamation"></i><span id="warningText">All fields required</span></div>
        <div id="loaderArea" class="hidden p-4 bg-white rounded-lg border"><div class="flex items-center gap-3"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div><div><div class="font-medium">Analyzing<span class="dots"></span></div><div class="text-xs text-gray-500">computing non‚Äëlinear scores ...</div></div></div></div>

        <!-- final results (hidden by default) -->
        <div id="finalResults" class="fade-in hidden space-y-4">
          <div class="bg-green-50 p-4 rounded-lg"><div class="flex justify-between"><h3 class="font-medium text-green-800">Growth score (sigmoid)</h3><span id="growthScoreLabel" class="text-xl font-bold text-green-700">0/100</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="growthBar" class="progress-bar bg-green-600 h-2.5 rounded-full" style="width:0%"></div></div></div>
          
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-blue-50 p-4 rounded-lg"><h3 class="font-medium text-blue-800">Expected yield</h3><p id="expectedYieldLabel" class="text-2xl font-bold text-blue-700">‚Äî kg/ha</p></div>
            <div class="bg-purple-50 p-4 rounded-lg"><h3 class="font-medium text-purple-800">Disease risk</h3><p id="diseaseRiskLabel" class="text-2xl font-bold text-red-600">‚Äî</p><p id="riskScoreLabel" class="text-xs text-gray-600">score 0%</p></div>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-yellow-50 p-4 rounded-lg"><h3 class="font-medium text-yellow-800">Soil compat.</h3><div class="flex items-center"><span id="soilScoreLabel" class="text-2xl font-bold text-yellow-700 mr-2">0%</span><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="soilBar" class="progress-bar bg-yellow-500 h-2.5 rounded-full" style="width:0%"></div></div></div></div>
            <div class="bg-indigo-50 p-4 rounded-lg"><h3 class="font-medium text-indigo-800">Weather compat.</h3><div class="flex items-center"><span id="weatherScoreLabel" class="text-2xl font-bold text-indigo-700 mr-2">0%</span><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="weatherBar" class="progress-bar bg-indigo-500 h-2.5 rounded-full" style="width:0%"></div></div></div></div>
          </div>
          
          <div class="bg-gray-50 p-4 rounded-lg"><h3 class="font-medium text-gray-800">Match summary</h3><p id="matchSummaryLabel" class="text-lg font-semibold text-gray-800">‚Äî</p></div>
          
          <!-- SCIENTIFIC FERTILISER RECOMMENDATION (enhanced) -->
          <div class="bg-white border-2 border-green-200 p-4 rounded-lg">
            <div class="flex justify-between items-center mb-3">
              <h3 class="font-bold text-green-800">üåæ ICAR-Based Fertilizer Recommendation</h3>
              <button id="viewDetailsBtn" class="text-xs bg-green-600 text-white px-3 py-1 rounded-full hover:bg-green-700">technical details</button>
            </div>
            
            <!-- Status badges -->
            <div class="grid grid-cols-3 gap-2 mb-4">
              <div class="text-center">
                <span class="text-sm font-medium">Nitrogen</span>
                <div><span id="nStatusBadge" class="status-badge">‚Äî</span></div>
              </div>
              <div class="text-center">
                <span class="text-sm font-medium">Phosphorus</span>
                <div><span id="pStatusBadge" class="status-badge">‚Äî</span></div>
              </div>
              <div class="text-center">
                <span class="text-sm font-medium">Potassium</span>
                <div><span id="kStatusBadge" class="status-badge">‚Äî</span></div>
              </div>
            </div>
            
            <!-- Fertilizer doses -->
            <div class="grid grid-cols-3 gap-3 mb-4">
              <div class="bg-blue-50 p-2 rounded text-center">
                <div class="text-xs text-gray-600">Urea (kg/ha)</div>
                <div class="text-xl font-bold text-blue-700" id="ureaDose">0</div>
              </div>
              <div class="bg-purple-50 p-2 rounded text-center">
                <div class="text-xs text-gray-600">DAP (kg/ha)</div>
                <div class="text-xl font-bold text-purple-700" id="dapDose">0</div>
              </div>
              <div class="bg-amber-50 p-2 rounded text-center">
                <div class="text-xs text-gray-600">MOP (kg/ha)</div>
                <div class="text-xl font-bold text-amber-700" id="mopDose">0</div>
              </div>
            </div>
            
            <!-- Application methods -->
            <div class="space-y-2 text-sm">
              <div class="bg-green-50 p-2 rounded" id="nitrogenMethod">
                <span class="font-semibold">Nitrogen:</span> <span id="nitrogenMethodText">‚Äî</span>
              </div>
              <div class="bg-green-50 p-2 rounded" id="phosphorusMethod">
                <span class="font-semibold">Phosphorus:</span> <span id="phosphorusMethodText">‚Äî</span>
              </div>
              <div class="bg-green-50 p-2 rounded" id="potassiumMethod">
                <span class="font-semibold">Potassium:</span> <span id="potassiumMethodText">‚Äî</span>
              </div>
            </div>
            
            <!-- Warnings -->
            <div id="fertilizerWarnings" class="mt-3 space-y-1"></div>
          </div>

          <!-- charts -->
          <div class="bg-white p-3 rounded-lg border"><canvas id="compareChart" height="140"></canvas></div>
          <div class="bg-white p-3 rounded-lg border"><canvas id="npkChart" height="110"></canvas></div>
          <div class="bg-white p-3 rounded-lg border"><canvas id="fertBChart" height="110"></canvas></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- disease modal -->
<div id="diseaseModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4 z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-auto p-6">
    <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-green-800">Rice Disease Information</h3><button id="closeModal" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button></div>
    <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500">Disease</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500">Triggers</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500">Symptoms</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500">Prevention</th></tr></thead><tbody id="diseaseTbody"></tbody></table>
  </div>
</div>

<!-- fertilizer technical modal -->
<div id="fertilizerModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4 z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-auto p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold text-green-800">Technical Fertilizer Calculations</h3>
      <button id="closeFertilizerModal" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
    </div>
    <div id="fertilizerDetails" class="space-y-4"></div>
  </div>
</div>

<script>
(function() {
  // ========================================================
  // SCIENTIFIC RICE FERTILIZER RECOMMENDATION MODEL
  // Based on ICAR guidelines and non-linear deficiency approach
  // ========================================================
  
  function calculateRiceFertilizer(N, P, K) {
    // Ideal ranges and sigma values
    const ideals = {
      N: { min: 120, max: 150, ideal: 135, sigma: 25, baseDose: 80, maintDose: 20 },
      P: { min: 40, max: 60, ideal: 50, sigma: 12, baseDose: 60, maintDose: 20 },
      K: { min: 40, max: 60, ideal: 50, sigma: 12, baseDose: 50, maintDose: 20 }
    };

    // Conversion factors (nutrient to fertilizer)
    // Urea: 46% N, DAP: 46% P2O5, MOP: 60% K2O
    const conversion = {
      NtoUrea: 2.17,  // 100/46 ‚âà 2.17 kg Urea per kg N
      PtoDAP: 2.17,   // 100/46 ‚âà 2.17 kg DAP per kg P2O5
      KtoMOP: 1.67    // 100/60 ‚âà 1.67 kg MOP per kg K2O
    };

    let warnings = [];
    let result = {
      nitrogenStatus: "",
      phosphorusStatus: "",
      potassiumStatus: "",
      ureaKgPerHa: 0,
      dapKgPerHa: 0,
      mopKgPerHa: 0,
      applicationMethod: {
        nitrogen: "",
        phosphorus: "",
        potassium: ""
      },
      warnings: warnings
    };

    // Gaussian suitability function
    function calculateSuitability(value, ideal, sigma) {
      const diff = value - ideal;
      return Math.exp(-(diff * diff) / (2 * sigma * sigma));
    }

    // Calculate for each nutrient
    ['N', 'P', 'K'].forEach(nutrient => {
      const value = nutrient === 'N' ? N : (nutrient === 'P' ? P : K);
      const config = ideals[nutrient];
      
      // Calculate suitability and deficiency
      const suitability = calculateSuitability(value, config.ideal, config.sigma);
      const deficiency = 1 - suitability;
      
      // Determine status
      let status;
      if (value < config.min) status = "Deficient";
      else if (value > config.max) status = "Excess";
      else status = "Optimal";
      
      // Set status in result
      if (nutrient === 'N') result.nitrogenStatus = status;
      else if (nutrient === 'P') result.phosphorusStatus = status;
      else if (nutrient === 'K') result.potassiumStatus = status;
      
      // Calculate dose (nutrient kg/ha)
      let nutrientDose = 0;
      
      if (value < config.ideal) {
        // DEFICIENT: dose = baseDose √ó (deficiency ^ 1.5)
        nutrientDose = config.baseDose * Math.pow(deficiency, 1.5);
        
        // Apply special rules
        if (nutrient === 'K' && value < 35) {
          nutrientDose = nutrientDose * 1.1; // 10% increase for very low K
          warnings.push("‚ö†Ô∏è Low Potassium (<35 kg/ha): Increased lodging and brown spot risk. Extra 10% K recommended.");
        }
        
        // Round to nearest kg
        nutrientDose = Math.round(nutrientDose);
        if (nutrientDose < 20) nutrientDose = 20; // Minimum dose
        
      } else if (value <= config.max) {
        // OPTIMAL: maintenance dose
        nutrientDose = config.maintDose;
      } else {
        // EXCESS: no dose, add warning
        nutrientDose = 0;
        if (nutrient === 'N' && value > 160) {
          warnings.push("‚ö†Ô∏è High Nitrogen (>160 kg/ha): Increases blast and sheath blight risk. Avoid N application.");
        } else if (nutrient === 'N') {
          warnings.push("‚ö†Ô∏è Nitrogen in excess: May increase disease risk and lodging.");
        } else if (nutrient === 'P') {
          warnings.push("‚ö†Ô∏è Phosphorus in excess: May cause zinc deficiency.");
        } else if (nutrient === 'K') {
          warnings.push("‚ö†Ô∏è Potassium in excess: May reduce magnesium uptake.");
        }
      }
      
      // Convert to fertilizer amounts and set application methods
      if (nutrient === 'N') {
        result.ureaKgPerHa = Math.round(nutrientDose * conversion.NtoUrea);
        if (status === "Deficient") {
          result.applicationMethod.nitrogen = 
            "Split application: 50% basal, 25% at tillering (20-25 DAT), 25% at panicle initiation (50-55 DAT)";
        } else if (status === "Optimal") {
          result.applicationMethod.nitrogen = "Maintenance dose: Apply at tillering stage";
        } else {
          result.applicationMethod.nitrogen = "No nitrogen application recommended";
        }
      } else if (nutrient === 'P') {
        result.dapKgPerHa = Math.round(nutrientDose * conversion.PtoDAP);
        if (status === "Deficient") {
          result.applicationMethod.phosphorus = "Single basal dose: Apply and incorporate before transplanting";
        } else if (status === "Optimal") {
          result.applicationMethod.phosphorus = "Maintenance dose: Apply as basal";
        } else {
          result.applicationMethod.phosphorus = "No phosphorus application recommended";
        }
      } else if (nutrient === 'K') {
        result.mopKgPerHa = Math.round(nutrientDose * conversion.KtoMOP);
        if (status === "Deficient") {
          result.applicationMethod.potassium = "Split application: 50% basal, 50% at panicle initiation";
        } else if (status === "Optimal") {
          result.applicationMethod.potassium = "Maintenance dose: Apply as basal";
        } else {
          result.applicationMethod.potassium = "No potassium application recommended";
        }
      }
    });

    return result;
  }

  // ========================================================
  // EXISTING DATA AND FUNCTIONS (unchanged)
  // ========================================================
  const districtData = [
    { district: "Lucknow", pH: 6.9, moisture: 72, nitrogen: 198, phosphorus: 20, potassium: 174, temperature: 29.5, humidity: 78, rainfall: 920 },
    { district: "Agra", pH: 6.3, moisture: 65, nitrogen: 190, phosphorus: 18, potassium: 180, temperature: 30.8, humidity: 70, rainfall: 890 },
    { district: "Gorakhpur", pH: 6.6, moisture: 78, nitrogen: 220, phosphorus: 26, potassium: 165, temperature: 28.5, humidity: 84, rainfall: 1150 },
    { district: "Varanasi", pH: 6.0, moisture: 68, nitrogen: 130, phosphorus: 27, potassium: 229, temperature: 30.2, humidity: 80, rainfall: 960 },
    { district: "Jhansi", pH: 7.06, moisture: 64, nitrogen: 178, phosphorus: 8.5, potassium: 189, temperature: 31.2, humidity: 68, rainfall: 885 }
  ];

  const soilTextureRatings = { "Clay Loam": 5, "Silty Clay Loam": 4.5, "Silty Loam": 4, "Clay": 3 };

  const diseaseData = [ 
    { "name": "Blast Disease", "triggers": "N > 160, Humidity > 85%, Moisture > 80%", "symptoms": "Gray diamond spots", "prevention": "Reduce N, spacing, resistant vars" },
    { "name": "Bacterial Leaf Blight", "triggers": "Humidity > 90%, Rainfall > 1200 mm", "symptoms": "Leaf tip yellowing", "prevention": "Clean seeds, water management" },
    { "name": "Sheath Blight", "triggers": "N > 150, Moisture > 85%, Dense sowing", "symptoms": "Rot on lower sheath", "prevention": "Less N, spacing, fungicide" },
    { "name": "Brown Spot", "triggers": "K < 40, P < 40, Rainfall < 900", "symptoms": "Brown spots with halo", "prevention": "Balance K & P, irrigation" },
    { "name": "Tungro Virus", "triggers": "High humidity, Late sowing", "symptoms": "Orange-yellow leaves", "prevention": "Early sowing, vector control" },
    { "name": "Stem Rot", "triggers": "Continuous cropping, high N", "symptoms": "Hollow tillers, rot", "prevention": "Rotation, balanced N" },
    { "name": "False Smut", "triggers": "High humidity + rain at flowering, excess N", "symptoms": "Green smut balls", "prevention": "Remove infected grains, reduce N" },
    { "name": "Leaf Scald", "triggers": "Excess N, high humidity", "symptoms": "Brown lesions", "prevention": "Split N doses" },
    { "name": "Narrow Brown Spot", "triggers": "K < 40, Excess N", "symptoms": "Narrow brown lesions", "prevention": "Potassium fertilizer, reduce N" }
  ];

  // DOM elements
  const districtEl = document.getElementById('district');
  const soilPh = document.getElementById('soilPh'), soilMoisture = document.getElementById('soilMoisture'), soilTexture = document.getElementById('soilTexture');
  const nitrogen = document.getElementById('nitrogen'), phosphorus = document.getElementById('phosphorus'), potassium = document.getElementById('potassium');
  const temperature = document.getElementById('temperature'), humidity = document.getElementById('humidity'), rainfall = document.getElementById('rainfall');
  const calcBtn = document.getElementById('calculateBtn'), resetBtn = document.getElementById('resetBtn');
  const loader = document.getElementById('loaderArea'), finalDiv = document.getElementById('finalResults'), placeholder = document.getElementById('placeholderIntro'), warnBox = document.getElementById('warningBox'), warnText = document.getElementById('warningText');
  
  // Result labels
  const growthLbl = document.getElementById('growthScoreLabel'), growthBar = document.getElementById('growthBar');
  const yieldLbl = document.getElementById('expectedYieldLabel');
  const diseaseLbl = document.getElementById('diseaseRiskLabel'), riskScoreLbl = document.getElementById('riskScoreLabel');
  const soilScoreLbl = document.getElementById('soilScoreLabel'), soilBar = document.getElementById('soilBar');
  const weatherScoreLbl = document.getElementById('weatherScoreLabel'), weatherBar = document.getElementById('weatherBar');
  const summaryLbl = document.getElementById('matchSummaryLabel');
  
  // Fertilizer specific elements
  const nStatusBadge = document.getElementById('nStatusBadge');
  const pStatusBadge = document.getElementById('pStatusBadge');
  const kStatusBadge = document.getElementById('kStatusBadge');
  const ureaDose = document.getElementById('ureaDose');
  const dapDose = document.getElementById('dapDose');
  const mopDose = document.getElementById('mopDose');
  const nitrogenMethodText = document.getElementById('nitrogenMethodText');
  const phosphorusMethodText = document.getElementById('phosphorusMethodText');
  const potassiumMethodText = document.getElementById('potassiumMethodText');
  const fertilizerWarnings = document.getElementById('fertilizerWarnings');
  
  const viewDetails = document.getElementById('viewDetailsBtn');
  const downloadBtn = document.getElementById('downloadImageBtn');
  const diseaseBtn = document.getElementById('diseaseBtn'), diseaseModal = document.getElementById('diseaseModal'), closeModal = document.getElementById('closeModal');
  const fertModal = document.getElementById('fertilizerModal'), closeFertModal = document.getElementById('closeFertilizerModal'), fertDetails = document.getElementById('fertilizerDetails');
  
  let charts = { compare: null, npk: null, fertB: null };

  // Helper functions
  function softNormalize(value, min, max, ideal) {
    if (isNaN(value) || value === null) return 0;
    const sigma = (max - min) / 4;
    const diff = value - ideal;
    return Math.exp(-(diff * diff) / (2 * sigma * sigma));
  }

  function getTextureScore(texture) {
    return soilTextureRatings[texture] || 0;
  }

  function calculateSoilScore(ph, moisture, texture) {
    const phNorm = softNormalize(ph, 5.5, 7.5, 6.4);
    const moistNorm = softNormalize(moisture, 60, 90, 75);
    const texScore = getTextureScore(texture) / 5;
    return (phNorm * 0.4 + moistNorm * 0.4 + texScore * 0.2) * 100;
  }

  function calculateNutrientScore(N, P, K) {
    const nNorm = softNormalize(N, 80, 200, 135);
    const pNorm = softNormalize(P, 20, 90, 50);
    const kNorm = softNormalize(K, 20, 90, 50);
    return (nNorm * 0.5 + pNorm * 0.25 + kNorm * 0.25) * 100;
  }

  function calculateWeatherScore(temp, hum, rain) {
    const tNorm = softNormalize(temp, 22, 36, 30);
    const hNorm = softNormalize(hum, 55, 95, 75);
    const rNorm = softNormalize(rain, 800, 1500, 1100);
    return (tNorm * 0.4 + hNorm * 0.3 + rNorm * 0.3) * 100;
  }

  function sigmoidGrowth(soilSc, nutrSc, weatherSc) {
    let raw = soilSc * 0.4 + nutrSc * 0.35 + weatherSc * 0.25;
    const k = 0.08, midpoint = 50;
    return 100 / (1 + Math.exp(-k * (raw - midpoint)));
  }

  function logisticYield(finalGrowth) {
    const yMin = 2200, yMax = 3400;
    return yMin + (yMax - yMin) / (1 + Math.exp(-0.1 * (finalGrowth - 60)));
  }

  function computeDiseaseRisk(humidity, nitrogen, soilMoisture, pH) {
    let risk = 0;
    if (humidity > 85) risk += 30;
    if (nitrogen > 160) risk += 30;
    if (soilMoisture > 80) risk += 20;
    if (pH < 5.5 || pH > 7.5) risk += 20;
    risk = Math.min(risk, 100);
    let level = 'Low';
    if (risk > 60) level = 'High';
    else if (risk > 30) level = 'Medium';
    return { level, score: risk };
  }

  function performAnalysis() {
    const ph = parseFloat(soilPh.value) || 0, moist = parseFloat(soilMoisture.value) || 0;
    const texture = soilTexture.value;
    const N = parseFloat(nitrogen.value) || 0, P = parseFloat(phosphorus.value) || 0, K = parseFloat(potassium.value) || 0;
    const temp = parseFloat(temperature.value) || 0, hum = parseFloat(humidity.value) || 0, rain = parseFloat(rainfall.value) || 0;

    const soilSc = calculateSoilScore(ph, moist, texture);
    const nutrSc = calculateNutrientScore(N, P, K);
    const weatherSc = calculateWeatherScore(temp, hum, rain);
    const growth = sigmoidGrowth(soilSc, nutrSc, weatherSc);
    const growthRounded = Math.min(100, Math.max(0, Math.round(growth)));
    const yieldVal = logisticYield(growth);
    const yieldRounded = Math.round(yieldVal);
    const disease = computeDiseaseRisk(hum, N, moist, ph);
    
    let summary = '';
    if (growthRounded >= 75) summary = 'Excellent conditions for rice';
    else if (growthRounded >= 55) summary = 'Moderate / suitable conditions';
    else summary = 'Challenging conditions, check risks';

    // Get fertilizer recommendations using our scientific model
    const fertRec = calculateRiceFertilizer(N, P, K);

    return {
      growth: growthRounded,
      soil: Math.round(soilSc),
      weather: Math.round(weatherSc),
      yield: yieldRounded,
      diseaseLevel: disease.level,
      diseaseScore: disease.score,
      summary,
      N, P, K,
      fertRec
    };
  }

  function renderResults(d) {
    // Update basic metrics
    growthLbl.textContent = d.growth + '/100';
    growthBar.style.width = d.growth + '%';
    yieldLbl.textContent = d.yield + ' kg/ha';
    diseaseLbl.textContent = d.diseaseLevel;
    diseaseLbl.className = `text-2xl font-bold ${d.diseaseLevel==='Low'?'text-green-600': d.diseaseLevel==='Medium'?'text-yellow-600':'text-red-600'}`;
    riskScoreLbl.textContent = `score ${d.diseaseScore}%`;
    soilScoreLbl.textContent = d.soil + '%'; soilBar.style.width = d.soil + '%';
    weatherScoreLbl.textContent = d.weather + '%'; weatherBar.style.width = d.weather + '%';
    summaryLbl.textContent = d.summary;

    // Update fertilizer recommendations
    const f = d.fertRec;
    
    // Status badges
    nStatusBadge.textContent = f.nitrogenStatus;
    pStatusBadge.textContent = f.phosphorusStatus;
    kStatusBadge.textContent = f.potassiumStatus;
    
    nStatusBadge.className = `status-badge status-${f.nitrogenStatus.toLowerCase()}`;
    pStatusBadge.className = `status-badge status-${f.phosphorusStatus.toLowerCase()}`;
    kStatusBadge.className = `status-badge status-${f.potassiumStatus.toLowerCase()}`;
    
    // Fertilizer doses
    ureaDose.textContent = f.ureaKgPerHa;
    dapDose.textContent = f.dapKgPerHa;
    mopDose.textContent = f.mopKgPerHa;
    
    // Application methods
    nitrogenMethodText.textContent = f.applicationMethod.nitrogen;
    phosphorusMethodText.textContent = f.applicationMethod.phosphorus;
    potassiumMethodText.textContent = f.applicationMethod.potassium;
    
    // Warnings
    fertilizerWarnings.innerHTML = '';
    f.warnings.forEach(w => {
      const warnEl = document.createElement('div');
      warnEl.className = 'text-xs p-2 bg-yellow-50 text-yellow-800 rounded border border-yellow-200';
      warnEl.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>${w}`;
      fertilizerWarnings.appendChild(warnEl);
    });

    // Charts
    const ctxComp = document.getElementById('compareChart').getContext('2d');
    if (charts.compare) charts.compare.destroy();
    charts.compare = new Chart(ctxComp, {
      type: 'bar', 
      data: { 
        labels: ['Growth', 'Soil', 'Weather'], 
        datasets: [{ 
          label: 'score', 
          data: [d.growth, d.soil, d.weather], 
          backgroundColor: ['#16a34a','#f59e0b','#0ea5e9'] 
        }]
      },
      options: { 
        responsive: true, 
        plugins: { legend: { display: false } }, 
        scales: { y: { max: 100, beginAtZero: true } } 
      }
    });

    const ctxNpk = document.getElementById('npkChart').getContext('2d');
    if (charts.npk) charts.npk.destroy();
    charts.npk = new Chart(ctxNpk, {
      type: 'bar', 
      data: { 
        labels: ['N', 'P', 'K'], 
        datasets: [{ 
          label: 'kg/ha', 
          data: [d.N, d.P, d.K], 
          backgroundColor: ['#15803d','#0ea5e9','#7c3aed'] 
        }]
      },
      options: { plugins: { legend: { display: false } } }
    });

    // Suitability chart
    const nDef = Math.round(softNormalize(d.N, 80,200,135)*100);
    const pDef = Math.round(softNormalize(d.P, 20,90,50)*100);
    const kDef = Math.round(softNormalize(d.K, 20,90,50)*100);
    const ctxB = document.getElementById('fertBChart').getContext('2d');
    if (charts.fertB) charts.fertB.destroy();
    charts.fertB = new Chart(ctxB, {
      type: 'bar', 
      data: { 
        labels: ['N suitability', 'P suitability', 'K suitability'], 
        datasets: [{ 
          label: 'suitability %', 
          data: [nDef, pDef, kDef], 
          backgroundColor: ['#16a34a','#0ea5e9','#f59e0b'] 
        }]
      },
      options: { 
        plugins: { legend: { display: false } }, 
        scales: { y: { max:100, beginAtZero: true } } 
      }
    });

    finalDiv.classList.remove('hidden');
    setTimeout(() => finalDiv.classList.add('show'), 20);
  }

  function allFilled() {
    return [districtEl.value, soilTexture.value, soilPh.value, soilMoisture.value, nitrogen.value, phosphorus.value, potassium.value, temperature.value, humidity.value, rainfall.value].every(v => v && v.toString().trim()!=='');
  }

  // Event handlers
  calcBtn.addEventListener('click', () => {
    warnBox.classList.add('hidden');
    if (!allFilled()) {
      warnText.textContent = '‚ö† Please fill ALL fields (district, texture & numeric inputs)';
      warnBox.classList.remove('hidden');
      placeholder.classList.remove('hidden');
      loader.classList.add('hidden');
      finalDiv.classList.add('hidden');
      return;
    }
    placeholder.classList.add('hidden');
    finalDiv.classList.add('hidden');
    loader.classList.remove('hidden');

    setTimeout(() => {
      const res = performAnalysis();
      loader.classList.add('hidden');
      renderResults(res);
    }, 1000);
  });

  districtEl.addEventListener('change', () => {
    const d = districtData.find(x => x.district === districtEl.value);
    if (!d) return;
    soilPh.value = d.pH; soilMoisture.value = d.moisture; nitrogen.value = d.nitrogen;
    phosphorus.value = d.phosphorus; potassium.value = d.potassium;
    temperature.value = d.temperature; humidity.value = d.humidity; rainfall.value = d.rainfall;
    soilTexture.value = '';
  });

  resetBtn.addEventListener('click', () => {
    document.getElementById('cropForm').reset();
    finalDiv.classList.add('hidden'); finalDiv.classList.remove('show');
    loader.classList.add('hidden');
    placeholder.classList.remove('hidden');
    warnBox.classList.add('hidden');
    Object.values(charts).forEach(ch => { if(ch) ch.destroy(); });
    charts = { compare: null, npk: null, fertB: null };
  });

  function populateDiseaseTable() {
    const tbody = document.getElementById('diseaseTbody');
    tbody.innerHTML = '';
    diseaseData.forEach(d => {
      const tr = document.createElement('tr'); tr.className = 'disease-row';
      tr.innerHTML = `<td class="px-6 py-4 font-medium">${d.name}</td><td class="px-6 py-4 text-sm">${d.triggers}</td><td class="px-6 py-4 text-sm">${d.symptoms}</td><td class="px-6 py-4 text-sm">${d.prevention}</td>`;
      tbody.appendChild(tr);
    });
  }
  populateDiseaseTable();
  
  diseaseBtn.addEventListener('click', () => diseaseModal.classList.remove('hidden'));
  closeModal.addEventListener('click', () => diseaseModal.classList.add('hidden'));

  viewDetails.addEventListener('click', () => {
    const N = parseFloat(nitrogen.value) || 0, P = parseFloat(phosphorus.value) || 0, K = parseFloat(potassium.value) || 0;
    const fert = calculateRiceFertilizer(N, P, K);
    
    fertDetails.innerHTML = `
      <div class="bg-blue-50 p-4 rounded-lg">
        <h4 class="font-bold text-lg mb-2">üìä Gaussian Suitability Calculations</h4>
        <p class="text-sm mb-1">Nitrogen suitability = exp(-((${N} - 135)¬≤)/(2√ó25¬≤)) = ${Math.round(softNormalize(N,80,200,135)*100)}%</p>
        <p class="text-sm mb-1">Phosphorus suitability = exp(-((${P} - 50)¬≤)/(2√ó12¬≤)) = ${Math.round(softNormalize(P,20,90,50)*100)}%</p>
        <p class="text-sm">Potassium suitability = exp(-((${K} - 50)¬≤)/(2√ó12¬≤)) = ${Math.round(softNormalize(K,20,90,50)*100)}%</p>
      </div>
      <div class="bg-green-50 p-4 rounded-lg">
        <h4 class="font-bold text-lg mb-2">üß™ Nutrient Deficiency Index (1 - suitability)</h4>
        <p class="text-sm mb-1">N deficiency: ${(1 - softNormalize(N,80,200,135)).toFixed(3)}</p>
        <p class="text-sm mb-1">P deficiency: ${(1 - softNormalize(P,20,90,50)).toFixed(3)}</p>
        <p class="text-sm">K deficiency: ${(1 - softNormalize(K,20,90,50)).toFixed(3)}</p>
      </div>
      <div class="bg-purple-50 p-4 rounded-lg">
        <h4 class="font-bold text-lg mb-2">‚öóÔ∏è Nonlinear Dose Calculation (deficiency^1.5)</h4>
        <p class="text-sm mb-1">N dose factor = ${Math.pow(1 - softNormalize(N,80,200,135), 1.5).toFixed(3)}</p>
        <p class="text-sm mb-1">P dose factor = ${Math.pow(1 - softNormalize(P,20,90,50), 1.5).toFixed(3)}</p>
        <p class="text-sm">K dose factor = ${Math.pow(1 - softNormalize(K,20,90,50), 1.5).toFixed(3)}</p>
      </div>
    `;
    fertModal.classList.remove('hidden');
  });

  closeFertModal.addEventListener('click', () => fertModal.classList.add('hidden'));

  downloadBtn.addEventListener('click', () => {
    html2canvas(document.body, { scale: 1.5 }).then(canvas => {
      const link = document.createElement('a');
      link.download = `cropguard_${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }).catch(console.warn);
  });
})();
</script>
</body>
</html>