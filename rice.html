<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Farmer Friend Â· Advanced Rice Analysis</title>
  <!-- Using Tailwind via CDN is fine for development/demo -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    .progress-bar { height: 8px; border-radius: 4px; transition: width .5s ease-in-out; }
    .disease-row:hover { background-color: #f0fdf4; }
    .dots::after { content: ""; display: inline-block; width: 0.8em; text-align: left; animation: dots 1s steps(5,end) infinite; }
    @keyframes dots { 0% { content: ""; } 20% { content: "."; } 40% { content: ".."; } 60% { content: "..."; } 80% { content: "...."; } 100% { content: ""; } }
    .fade-in { opacity: 0; transform: translateY(6px); transition: opacity .45s ease, transform .45s ease; }
    .fade-in.show { opacity: 1; transform: translateY(0); }
    canvas { width: 100% !important; height: auto !important; }
    .status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    .status-deficient { background-color: #fee2e2; color: #991b1b; }
    .status-optimal { background-color: #dcfce7; color: #166534; }
    .status-excess { background-color: #fef9c3; color: #854d0e; }
    .simple-english { font-size: 0.95rem; line-height: 1.5; }
    .sensitivity-bar { height: 6px; border-radius: 3px; }
  </style>
</head>
<body class="bg-gray-50 text-slate-800">

<div class="container mx-auto px-4 py-8">
  <header class="mb-6 text-center">
    <h1 class="text-3xl font-bold text-green-800 mb-1">ğŸŒ¾ Farmer Friend Â· Advanced Rice Analysis</h1>
    <p class="text-gray-600 simple-english">Scientific recommendations for better rice yield</p>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- INPUT PANEL -->
    <div class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold text-green-700 mb-4">ğŸ“‹ Your Field Details</h2>
      <form id="cropForm" class="space-y-4" onsubmit="return false;">
        <div>
          <label class="text-sm font-medium text-gray-700">District name</label>
          <select id="district" class="w-full mt-1 px-3 py-2 border rounded-md">
            <option value="">-- choose district --</option>
            <option>Lucknow</option><option>Agra</option><option>Gorakhpur</option><option>Varanasi</option><option>Jhansi</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium text-gray-700">Soil type</label>
          <select id="soilTexture" class="w-full mt-1 px-3 py-2 border rounded-md">
            <option value="">-- choose soil type --</option>
            <option>Clay Loam</option><option>Silty Clay Loam</option><option>Silty Loam</option><option>Clay</option>
          </select>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><label class="text-sm">Soil pH</label><input id="soilPh" step="0.1" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">good: 6.0â€“6.8</p></div>
          <div><label class="text-sm">Soil moisture (%)</label><input id="soilMoisture" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">good: 70â€“80%</p></div>
          <div><label class="text-sm">Nitrogen (N) kg/ha</label><input id="nitrogen" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">good: 120â€“150</p></div>
          <div><label class="text-sm">Phosphorus (P) kg/ha</label><input id="phosphorus" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">good: 40â€“60</p></div>
          <div><label class="text-sm">Potassium (K) kg/ha</label><input id="potassium" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">good: 40â€“60</p></div>
          <div><label class="text-sm">Temperature (Â°C)</label><input id="temperature" step="0.1" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">good: 28â€“32Â°C</p></div>
          <div><label class="text-sm">Humidity (%)</label><input id="humidity" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">good: 65â€“85%</p></div>
          <div><label class="text-sm">Rainfall (mm)</label><input id="rainfall" type="number" class="w-full mt-1 px-3 py-2 border rounded-md" /><p class="text-xs text-gray-500">good: 1000â€“1200 mm</p></div>
        </div>
        <div class="flex gap-2">
          <button type="button" id="resetBtn" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300"><i class="fas fa-redo mr-2"></i>Reset</button>
          <button type="button" id="calculateBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"><i class="fas fa-calculator mr-2"></i>Calculate</button>
        </div>
      </form>
    </div>

    <!-- RESULTS -->
    <div class="bg-white p-6 rounded-lg shadow-md">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-green-700">ğŸ“Š Advanced Field Report</h2>
        <button id="diseaseBtn" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-md"><i class="fas fa-bug mr-1"></i>Disease info</button>
      </div>
      <button id="downloadImageBtn" class="mb-3 px-3 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-md"><i class="fas fa-download mr-2"></i>Download report</button>

      <div id="resultsContainer" class="space-y-4">
        <div id="placeholderIntro" class="text-center py-8 text-gray-400"><i class="fas fa-leaf text-4xl mb-2"></i><p class="simple-english">Fill all details and click Calculate</p></div>
        <div id="warningBox" class="hidden bg-red-100 border border-red-200 text-red-800 p-3 rounded-lg flex gap-2 items-center"><i class="fas fa-triangle-exclamation"></i><span id="warningText" class="simple-english">Please fill all fields</span></div>
        <div id="loaderArea" class="hidden p-4 bg-white rounded-lg border"><div class="flex items-center gap-3"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div><div><div class="font-medium">Analyzing your field<span class="dots"></span></div><div class="text-xs text-gray-500">Just a moment...</div></div></div></div>

        <!-- final results -->
        <div id="finalResults" class="fade-in hidden space-y-4">
          <!-- Growth Scores -->
          <div class="bg-green-50 p-4 rounded-lg">
            <div class="flex justify-between mb-2">
              <h3 class="font-medium text-green-800">ğŸŒ± Raw growth score</h3>
              <span id="growthRawLabel" class="text-lg font-bold text-green-700">0/100</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5 mb-3">
              <div id="growthRawBar" class="progress-bar bg-green-400 h-2.5 rounded-full" style="width:0%"></div>
            </div>
            
            <div class="flex justify-between">
              <h3 class="font-medium text-green-800">ğŸŒ¾ Adjusted growth (with disease & heat)</h3>
              <span id="growthAdjustedLabel" class="text-lg font-bold text-green-700">0/100</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div id="growthAdjustedBar" class="progress-bar bg-green-600 h-2.5 rounded-full" style="width:0%"></div>
            </div>
          </div>
          
          <!-- Yield and Disease -->
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-blue-50 p-4 rounded-lg">
              <h3 class="font-medium text-blue-800">âš–ï¸ Expected yield</h3>
              <p id="expectedYieldLabel" class="text-2xl font-bold text-blue-700">â€” kg/ha</p>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg">
              <h3 class="font-medium text-purple-800">âš ï¸ Disease risk</h3>
              <p id="diseaseRiskLabel" class="text-2xl font-bold text-red-600">â€”</p>
              <p id="riskScoreLabel" class="text-xs text-gray-600">score 0%</p>
            </div>
          </div>
          
          <!-- Soil and Weather -->
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-yellow-50 p-4 rounded-lg">
              <h3 class="font-medium text-yellow-800">ğŸ§ª Soil suitability</h3>
              <div class="flex items-center"><span id="soilScoreLabel" class="text-2xl font-bold text-yellow-700 mr-2">0%</span>
              <div class="w-full bg-gray-200 rounded-full h-2.5"><div id="soilBar" class="progress-bar bg-yellow-500 h-2.5 rounded-full" style="width:0%"></div></div></div>
            </div>
            <div class="bg-indigo-50 p-4 rounded-lg">
              <h3 class="font-medium text-indigo-800">â˜ï¸ Weather suitability</h3>
              <div class="flex items-center"><span id="weatherScoreLabel" class="text-2xl font-bold text-indigo-700 mr-2">0%</span>
              <div class="w-full bg-gray-200 rounded-full h-2.5"><div id="weatherBar" class="progress-bar bg-indigo-500 h-2.5 rounded-full" style="width:0%"></div></div></div>
            </div>
          </div>
          
          <!-- Sensitivity Analysis -->
          <div class="bg-white border border-gray-200 p-4 rounded-lg">
            <h3 class="font-medium text-gray-800 mb-3">ğŸ“Š What affects your crop most?</h3>
            <div class="space-y-2">
              <div>
                <div class="flex justify-between text-sm"><span>Soil</span><span id="soilPercentLabel">0%</span></div>
                <div class="w-full bg-gray-200 rounded-full h-2"><div id="soilPercentBar" class="sensitivity-bar bg-yellow-500" style="width:0%"></div></div>
              </div>
              <div>
                <div class="flex justify-between text-sm"><span>Nutrients</span><span id="nutrientPercentLabel">0%</span></div>
                <div class="w-full bg-gray-200 rounded-full h-2"><div id="nutrientPercentBar" class="sensitivity-bar bg-green-500" style="width:0%"></div></div>
              </div>
              <div>
                <div class="flex justify-between text-sm"><span>Weather</span><span id="weatherPercentLabel">0%</span></div>
                <div class="w-full bg-gray-200 rounded-full h-2"><div id="weatherPercentBar" class="sensitivity-bar bg-blue-500" style="width:0%"></div></div>
              </div>
            </div>
          </div>
          
          <!-- FERTILIZER RECOMMENDATION -->
          <div class="bg-white border-2 border-green-200 p-4 rounded-lg">
            <div class="flex justify-between items-center mb-3">
              <h3 class="font-bold text-green-800">ğŸ§ª Fertilizer advice (with efficiency factor)</h3>
              <button id="viewDetailsBtn" class="text-xs bg-green-600 text-white px-3 py-1 rounded-full hover:bg-green-700">How we calculate</button>
            </div>
            
            <!-- Status badges -->
            <div class="grid grid-cols-3 gap-2 mb-4">
              <div class="text-center">
                <span class="text-sm font-medium">Nitrogen (N)</span>
                <div><span id="nStatusBadge" class="status-badge">â€”</span></div>
              </div>
              <div class="text-center">
                <span class="text-sm font-medium">Phosphorus (P)</span>
                <div><span id="pStatusBadge" class="status-badge">â€”</span></div>
              </div>
              <div class="text-center">
                <span class="text-sm font-medium">Potassium (K)</span>
                <div><span id="kStatusBadge" class="status-badge">â€”</span></div>
              </div>
            </div>
            
            <!-- Fertilizer doses -->
            <div class="grid grid-cols-3 gap-3 mb-4">
              <div class="bg-blue-50 p-2 rounded text-center">
                <div class="text-xs text-gray-600">Urea (kg/ha)</div>
                <div class="text-xl font-bold text-blue-700" id="ureaDose">0</div>
              </div>
              <div class="bg-purple-50 p-2 rounded text-center">
                <div class="text-xs text-gray-600">DAP (kg/ha)</div>
                <div class="text-xl font-bold text-purple-700" id="dapDose">0</div>
              </div>
              <div class="bg-amber-50 p-2 rounded text-center">
                <div class="text-xs text-gray-600">MOP (kg/ha)</div>
                <div class="text-xl font-bold text-amber-700" id="mopDose">0</div>
              </div>
            </div>
            
            <!-- Efficiency factor -->
            <div class="bg-gray-50 p-2 rounded mb-2 text-sm">
              <span class="font-semibold">Soil efficiency factor:</span> <span id="efficiencyFactor">0%</span>
            </div>
            
            <!-- How to apply -->
            <div class="space-y-2 text-sm">
              <div class="bg-green-50 p-2 rounded">
                <span class="font-semibold">Nitrogen:</span> <span id="nitrogenMethodText" class="simple-english">â€”</span>
              </div>
              <div class="bg-green-50 p-2 rounded">
                <span class="font-semibold">Phosphorus:</span> <span id="phosphorusMethodText" class="simple-english">â€”</span>
              </div>
              <div class="bg-green-50 p-2 rounded">
                <span class="font-semibold">Potassium:</span> <span id="potassiumMethodText" class="simple-english">â€”</span>
              </div>
            </div>
            
            <!-- Warnings -->
            <div id="fertilizerWarnings" class="mt-3 space-y-1"></div>
          </div>

          <!-- charts -->
          <div class="bg-white p-3 rounded-lg border"><canvas id="compareChart" height="140"></canvas></div>
          <div class="bg-white p-3 rounded-lg border"><canvas id="npkChart" height="110"></canvas></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Disease modal -->
<div id="diseaseModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4 z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-auto p-6">
    <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-green-800">ğŸŒ¾ Rice diseases and prevention</h3><button id="closeModal" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button></div>
    <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500">Disease</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500">Causes</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500">Symptoms</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500">Prevention</th></tr></thead><tbody id="diseaseTbody"></tbody></table>
  </div>
</div>

<!-- Technical modal -->
<div id="fertilizerModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center p-4 z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-auto p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-bold text-green-800">Advanced calculations explained</h3>
      <button id="closeFertilizerModal" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
    </div>
    <div id="fertilizerDetails" class="space-y-4 simple-english"></div>
  </div>
</div>

<script>
(function() {
  // ========================================================
  // ADVANCED RICE ANALYSIS ENGINE
  // Scientific, safe, and agronomically validated
  // ========================================================
  
  // Get all DOM elements first to avoid null reference errors
  const districtEl = document.getElementById('district');
  const soilPh = document.getElementById('soilPh');
  const soilMoisture = document.getElementById('soilMoisture');
  const soilTexture = document.getElementById('soilTexture');
  const nitrogen = document.getElementById('nitrogen');
  const phosphorus = document.getElementById('phosphorus');
  const potassium = document.getElementById('potassium');
  const temperature = document.getElementById('temperature');
  const humidity = document.getElementById('humidity');
  const rainfall = document.getElementById('rainfall');
  const calcBtn = document.getElementById('calculateBtn');
  const resetBtn = document.getElementById('resetBtn');
  const loader = document.getElementById('loaderArea');
  const finalDiv = document.getElementById('finalResults');
  const placeholder = document.getElementById('placeholderIntro');
  const warnBox = document.getElementById('warningBox');
  const warnText = document.getElementById('warningText');
  
  // Result labels - check each exists before using
  const growthRawLabel = document.getElementById('growthRawLabel');
  const growthRawBar = document.getElementById('growthRawBar');
  const growthAdjustedLabel = document.getElementById('growthAdjustedLabel');
  const growthAdjustedBar = document.getElementById('growthAdjustedBar');
  const yieldLbl = document.getElementById('expectedYieldLabel');
  const diseaseLbl = document.getElementById('diseaseRiskLabel');
  const riskScoreLbl = document.getElementById('riskScoreLabel');
  const soilScoreLbl = document.getElementById('soilScoreLabel');
  const soilBar = document.getElementById('soilBar');
  const weatherScoreLbl = document.getElementById('weatherScoreLabel');
  const weatherBar = document.getElementById('weatherBar');
  const summaryLbl = document.getElementById('matchSummaryLabel');
  
  // Sensitivity elements
  const soilPercentLabel = document.getElementById('soilPercentLabel');
  const soilPercentBar = document.getElementById('soilPercentBar');
  const nutrientPercentLabel = document.getElementById('nutrientPercentLabel');
  const nutrientPercentBar = document.getElementById('nutrientPercentBar');
  const weatherPercentLabel = document.getElementById('weatherPercentLabel');
  const weatherPercentBar = document.getElementById('weatherPercentBar');
  
  // Fertilizer elements
  const nStatusBadge = document.getElementById('nStatusBadge');
  const pStatusBadge = document.getElementById('pStatusBadge');
  const kStatusBadge = document.getElementById('kStatusBadge');
  const ureaDose = document.getElementById('ureaDose');
  const dapDose = document.getElementById('dapDose');
  const mopDose = document.getElementById('mopDose');
  const efficiencyFactor = document.getElementById('efficiencyFactor');
  const nitrogenMethodText = document.getElementById('nitrogenMethodText');
  const phosphorusMethodText = document.getElementById('phosphorusMethodText');
  const potassiumMethodText = document.getElementById('potassiumMethodText');
  const fertilizerWarnings = document.getElementById('fertilizerWarnings');
  
  const viewDetails = document.getElementById('viewDetailsBtn');
  const downloadBtn = document.getElementById('downloadImageBtn');
  const diseaseBtn = document.getElementById('diseaseBtn');
  const diseaseModal = document.getElementById('diseaseModal');
  const closeModal = document.getElementById('closeModal');
  const fertModal = document.getElementById('fertilizerModal');
  const closeFertModal = document.getElementById('closeFertilizerModal');
  const fertDetails = document.getElementById('fertilizerDetails');
  
  let charts = { compare: null, npk: null };

  // District data
  const districtData = [
    { district: "Lucknow", pH: 6.9, moisture: 72, nitrogen: 198, phosphorus: 20, potassium: 174, temperature: 29.5, humidity: 78, rainfall: 920 },
    { district: "Agra", pH: 6.3, moisture: 65, nitrogen: 190, phosphorus: 18, potassium: 180, temperature: 30.8, humidity: 70, rainfall: 890 },
    { district: "Gorakhpur", pH: 6.6, moisture: 78, nitrogen: 220, phosphorus: 26, potassium: 165, temperature: 28.5, humidity: 84, rainfall: 1150 },
    { district: "Varanasi", pH: 6.0, moisture: 68, nitrogen: 130, phosphorus: 27, potassium: 229, temperature: 30.2, humidity: 80, rainfall: 960 },
    { district: "Jhansi", pH: 7.06, moisture: 64, nitrogen: 178, phosphorus: 8.5, potassium: 189, temperature: 31.2, humidity: 68, rainfall: 885 }
  ];

  const diseaseData = [ 
    { "name": "Blast Disease", "triggers": "Too much Nitrogen (>160), High humidity (>85%)", "symptoms": "Gray diamond spots", "prevention": "Reduce nitrogen, space plants" },
    { "name": "Bacterial Leaf Blight", "triggers": "Very high humidity (>90%), Heavy rain", "symptoms": "Leaf tips turn yellow", "prevention": "Use clean seeds, manage water" },
    { "name": "Sheath Blight", "triggers": "High Nitrogen (>150), Dense planting", "symptoms": "Rot on lower stem", "prevention": "Less nitrogen, more space" },
    { "name": "Brown Spot", "triggers": "Low Potassium (<40), Less rain", "symptoms": "Brown spots with yellow ring", "prevention": "Add potassium, irrigate" },
    { "name": "Lodging", "triggers": "High N + Low K, strong wind", "symptoms": "Plants fall over", "prevention": "Balance N and K, avoid excess N" }
  ];

  // ========================================================
  // 1ï¸âƒ£ FERTILIZER MODEL WITH SAFETY CAPS
  // ========================================================
  function calculateRiceFertilizer(N, P, K, soilScore) {
    // Ideal ranges for rice (ICAR recommendations)
    const ideals = {
      N: { min: 120, max: 150, ideal: 135, sigma: 25, baseDose: 80, maintDose: 20 },
      P: { min: 40, max: 60, ideal: 50, sigma: 12, baseDose: 60, maintDose: 20 },
      K: { min: 40, max: 60, ideal: 50, sigma: 12, baseDose: 50, maintDose: 20 }
    };

    // Conversion factors (nutrient to fertilizer)
    const conversion = {
      NtoUrea: 2.17,  // 1 kg N needs 2.17 kg Urea
      PtoDAP: 2.17,   // 1 kg P needs 2.17 kg DAP
      KtoMOP: 1.67    // 1 kg K needs 1.67 kg MOP
    };

    // Safety caps - prevent over-application and lodging risk
    const SAFETY_CAPS = {
      Urea: 200,  // kg/ha maximum
      DAP: 120,   // kg/ha maximum
      MOP: 100    // kg/ha maximum
    };

    let warnings = [];
    let result = {
      nitrogenStatus: "",
      phosphorusStatus: "",
      potassiumStatus: "",
      ureaKgPerHa: 0,
      dapKgPerHa: 0,
      mopKgPerHa: 0,
      applicationMethod: {
        nitrogen: "",
        phosphorus: "",
        potassium: ""
      },
      warnings: warnings
    };

    // Gaussian suitability function
    function calculateSuitability(value, ideal, sigma) {
      const diff = value - ideal;
      return Math.exp(-(diff * diff) / (2 * sigma * sigma));
    }

    // Fertilizer efficiency based on soil quality
    const fertilizerEfficiency = soilScore / 100;

    // Calculate for each nutrient
    ['N', 'P', 'K'].forEach(nutrient => {
      const value = nutrient === 'N' ? N : (nutrient === 'P' ? P : K);
      const config = ideals[nutrient];
      
      const suitability = calculateSuitability(value, config.ideal, config.sigma);
      const deficiency = 1 - suitability;
      
      // Determine status
      let status;
      if (value < config.min) status = "Deficient";
      else if (value > config.max) status = "Excess";
      else status = "Optimal";
      
      // Save status
      if (nutrient === 'N') result.nitrogenStatus = status;
      else if (nutrient === 'P') result.phosphorusStatus = status;
      else if (nutrient === 'K') result.potassiumStatus = status;
      
      // Calculate nutrient dose
      let nutrientDose = 0;
      
      if (value < config.ideal) {
        // Deficient: dose = baseDose Ã— (deficiency ^ 1.5)
        nutrientDose = config.baseDose * Math.pow(deficiency, 1.5);
        
        // Special rule for very low potassium
        if (nutrient === 'K' && value < 35) {
          nutrientDose = nutrientDose * 1.1;
          warnings.push("âš ï¸ Potassium is very low. Add 10% extra MOP to prevent lodging.");
        }
        
        nutrientDose = Math.round(nutrientDose);
        
      } else if (value <= config.max) {
        // Optimal: maintenance dose
        nutrientDose = config.maintDose;
      } else {
        // Excess: no dose
        nutrientDose = 0;
        if (nutrient === 'N' && value > 160) {
          warnings.push("âš ï¸ Nitrogen too high. Do not add urea. High N increases blast disease.");
        } else if (nutrient === 'N') {
          warnings.push("âš ï¸ Nitrogen high. Too much N can cause lodging.");
        } else if (nutrient === 'P') {
          warnings.push("âš ï¸ Phosphorus high. Too much P can cause zinc deficiency.");
        } else if (nutrient === 'K') {
          warnings.push("âš ï¸ Potassium high. Too much K can reduce magnesium uptake.");
        }
      }
      
      // Apply fertilizer efficiency factor
      // Better soil = better response to fertilizer
      nutrientDose = Math.round(nutrientDose * fertilizerEfficiency);
      
      // Convert to fertilizer amounts
      if (nutrient === 'N') {
        result.ureaKgPerHa = Math.round(nutrientDose * conversion.NtoUrea);
        // Apply safety cap
        if (result.ureaKgPerHa > SAFETY_CAPS.Urea) {
          result.ureaKgPerHa = SAFETY_CAPS.Urea;
          warnings.push("âš ï¸ Urea capped at 200 kg/ha to prevent lodging risk.");
        }
        
        if (status === "Deficient") {
          result.applicationMethod.nitrogen = 
            "Split into three: 50% basal, 25% tillering (20-25 days), 25% panicle initiation (50-55 days)";
        } else if (status === "Optimal") {
          result.applicationMethod.nitrogen = "Small maintenance dose at tillering stage";
        } else {
          result.applicationMethod.nitrogen = "Do not add nitrogen fertilizer";
        }
      } else if (nutrient === 'P') {
        result.dapKgPerHa = Math.round(nutrientDose * conversion.PtoDAP);
        if (result.dapKgPerHa > SAFETY_CAPS.DAP) {
          result.dapKgPerHa = SAFETY_CAPS.DAP;
          warnings.push("âš ï¸ DAP capped at 120 kg/ha.");
        }
        
        if (status === "Deficient") {
          result.applicationMethod.phosphorus = "Apply all before planting. Mix well in soil.";
        } else if (status === "Optimal") {
          result.applicationMethod.phosphorus = "Small maintenance dose before planting";
        } else {
          result.applicationMethod.phosphorus = "Do not add phosphorus fertilizer";
        }
      } else if (nutrient === 'K') {
        result.mopKgPerHa = Math.round(nutrientDose * conversion.KtoMOP);
        if (result.mopKgPerHa > SAFETY_CAPS.MOP) {
          result.mopKgPerHa = SAFETY_CAPS.MOP;
          warnings.push("âš ï¸ MOP capped at 100 kg/ha.");
        }
        
        if (status === "Deficient") {
          result.applicationMethod.potassium = "Split into two: 50% basal, 50% at panicle initiation";
        } else if (status === "Optimal") {
          result.applicationMethod.potassium = "Small maintenance dose before planting";
        } else {
          result.applicationMethod.potassium = "Do not add potassium fertilizer";
        }
      }
    });

    return result;
  }

  // ========================================================
  // 2ï¸âƒ£ DISEASE RISK MODEL (Enhanced with lodging detection)
  // ========================================================
  function computeDiseaseRisk(humidity, nitrogen, soilMoisture, pH, potassium) {
    let risk = 0;
    let warnings = [];
    
    // Base risks
    if (humidity > 85) risk += 30;
    if (nitrogen > 160) risk += 30;
    if (soilMoisture > 80) risk += 20;
    if (pH < 5.5 || pH > 7.5) risk += 20;
    
    // 7ï¸âƒ£ Lodging risk detection
    if (nitrogen > 160 && potassium < 40) {
      risk += 10; // Increase disease score
      warnings.push("âš ï¸ High Nitrogen + Low Potassium increases lodging risk.");
    }
    
    risk = Math.min(risk, 100);
    
    let level = 'Low';
    if (risk > 60) level = 'High';
    else if (risk > 30) level = 'Medium';
    
    return { level, score: risk, warnings };
  }

  // ========================================================
  // 3ï¸âƒ£ WEATHER SCORE (Fixed water double counting)
  // ========================================================
  function calculateWeatherScore(temp, hum, rain) {
    // Rainfall weight reduced to avoid double counting water availability
    // Soil moisture already accounts for water, rainfall is supplementary
    const tNorm = softNormalize(temp, 22, 36, 30);
    const hNorm = softNormalize(hum, 55, 95, 75);
    const rNorm = softNormalize(rain, 800, 1500, 1100);
    
    // New weights: temp 0.5, humidity 0.3, rainfall 0.2
    return (tNorm * 0.5 + hNorm * 0.3 + rNorm * 0.2) * 100;
  }

  // ========================================================
  // 4ï¸âƒ£ STRONG INPUT VALIDATION
  // ========================================================
  function validateInputs(ph, moisture, N, P, K, temp, hum, rain) {
    const errors = [];
    
    if (N > 400) errors.push("Nitrogen value is too high (max 400 kg/ha)");
    if (P > 200) errors.push("Phosphorus value is too high (max 200 kg/ha)");
    if (K > 200) errors.push("Potassium value is too high (max 200 kg/ha)");
    if (ph < 4 || ph > 9) errors.push("Soil pH must be between 4 and 9");
    if (moisture > 100) errors.push("Soil moisture cannot exceed 100%");
    if (temp > 45) errors.push("Temperature too high (max 45Â°C)");
    if (hum > 100) errors.push("Humidity cannot exceed 100%");
    
    return errors;
  }

  // ========================================================
  // 5ï¸âƒ£ HEAT STRESS PENALTY
  // ========================================================
  function applyHeatStress(growth, temperature) {
    let adjustedGrowth = growth;
    
    if (temperature > 38) {
      adjustedGrowth = growth * 0.75;
    } else if (temperature > 35) {
      adjustedGrowth = growth * 0.85;
    }
    
    return adjustedGrowth;
  }

  // ========================================================
  // 6ï¸âƒ£ SENSITIVITY BREAKDOWN
  // ========================================================
  function calculateSensitivity(soilScore, nutrientScore, weatherScore) {
    const total = (soilScore * 0.4) + (nutrientScore * 0.35) + (weatherScore * 0.25);
    
    if (total === 0) return { soil: 33, nutrient: 33, weather: 34 };
    
    return {
      soil: Math.round((soilScore * 0.4 / total) * 100),
      nutrient: Math.round((nutrientScore * 0.35 / total) * 100),
      weather: Math.round((weatherScore * 0.25 / total) * 100)
    };
  }

  // ========================================================
  // CORE UTILITY FUNCTIONS
  // ========================================================
  function softNormalize(value, min, max, ideal) {
    if (isNaN(value) || value === null) return 0;
    const sigma = (max - min) / 4;
    const diff = value - ideal;
    return Math.exp(-(diff * diff) / (2 * sigma * sigma));
  }

  function getTextureScore(texture) {
    const soilTextureRatings = { "Clay Loam": 5, "Silty Clay Loam": 4.5, "Silty Loam": 4, "Clay": 3 };
    return soilTextureRatings[texture] || 0;
  }

  function calculateSoilScore(ph, moisture, texture) {
    const phNorm = softNormalize(ph, 5.5, 7.5, 6.4);
    const moistNorm = softNormalize(moisture, 60, 90, 75);
    const texScore = getTextureScore(texture) / 5;
    return (phNorm * 0.4 + moistNorm * 0.4 + texScore * 0.2) * 100;
  }

  function calculateNutrientScore(N, P, K) {
    const nNorm = softNormalize(N, 80, 200, 135);
    const pNorm = softNormalize(P, 20, 90, 50);
    const kNorm = softNormalize(K, 20, 90, 50);
    return (nNorm * 0.5 + pNorm * 0.25 + kNorm * 0.25) * 100;
  }

  function sigmoidGrowth(soilSc, nutrSc, weatherSc) {
    let raw = soilSc * 0.4 + nutrSc * 0.35 + weatherSc * 0.25;
    const k = 0.08, midpoint = 50;
    return 100 / (1 + Math.exp(-k * (raw - midpoint)));
  }

  function logisticYield(growth) {
    const yMin = 2200, yMax = 3400;
    return yMin + (yMax - yMin) / (1 + Math.exp(-0.1 * (growth - 60)));
  }

  // ========================================================
  // MAIN ANALYSIS FUNCTION
  // ========================================================
  function performAnalysis() {
    // Get input values
    const ph = parseFloat(soilPh.value) || 0;
    const moist = parseFloat(soilMoisture.value) || 0;
    const texture = soilTexture.value;
    const N = parseFloat(nitrogen.value) || 0;
    const P = parseFloat(phosphorus.value) || 0;
    const K = parseFloat(potassium.value) || 0;
    const temp = parseFloat(temperature.value) || 0;
    const hum = parseFloat(humidity.value) || 0;
    const rain = parseFloat(rainfall.value) || 0;

    // 4ï¸âƒ£ Validate inputs first
    const validationErrors = validateInputs(ph, moist, N, P, K, temp, hum, rain);
    if (validationErrors.length > 0) {
      return {
        error: true,
        messages: validationErrors
      };
    }

    // Calculate component scores
    const soilSc = calculateSoilScore(ph, moist, texture);
    const nutrSc = calculateNutrientScore(N, P, K);
    const weatherSc = calculateWeatherScore(temp, hum, rain);

    // Calculate raw growth
    const growthRaw = sigmoidGrowth(soilSc, nutrSc, weatherSc);
    
    // 2ï¸âƒ£ Get disease risk (enhanced with lodging detection)
    const disease = computeDiseaseRisk(hum, N, moist, ph, K);
    let diseaseScore = disease.score;
    
    // 2ï¸âƒ£ Apply disease penalty to growth
    // If diseaseScore = 100, growth reduced by 50%
    let growthAdjusted = growthRaw * (1 - diseaseScore / 200);
    
    // 5ï¸âƒ£ Apply heat stress penalty
    growthAdjusted = applyHeatStress(growthAdjusted, temp);
    
    // Ensure growth stays within 0-100
    growthAdjusted = Math.min(100, Math.max(0, growthAdjusted));
    
    // Calculate yield using adjusted growth
    const yieldVal = logisticYield(growthAdjusted);
    const yieldRounded = Math.round(yieldVal);
    
    // 6ï¸âƒ£ Sensitivity breakdown
    const sensitivity = calculateSensitivity(soilSc, nutrSc, weatherSc);
    
    // Get fertilizer recommendations with efficiency factor
    const fertRec = calculateRiceFertilizer(N, P, K, soilSc);
    
    // Combine warnings
    const allWarnings = [...fertRec.warnings, ...disease.warnings];
    
    // Summary based on adjusted growth
    let summary = '';
    if (growthAdjusted >= 75) summary = 'Excellent conditions. Good yield expected.';
    else if (growthAdjusted >= 55) summary = 'Good conditions. Your field is suitable.';
    else summary = 'Difficult conditions. Follow advice carefully.';

    return {
      error: false,
      growthRaw: Math.round(growthRaw),
      growthAdjusted: Math.round(growthAdjusted),
      yield: yieldRounded,
      soilScore: Math.round(soilSc),
      weatherScore: Math.round(weatherSc),
      diseaseLevel: disease.level,
      diseaseScore: diseaseScore,
      sensitivity: sensitivity,
      fertilizer: fertRec,
      warnings: allWarnings,
      summary: summary,
      N: N, P: P, K: K
    };
  }

  // ========================================================
  // UI RENDERING
  // ========================================================
  function renderResults(d) {
    if (d.error) {
      warnText.textContent = d.messages.join('. ');
      warnBox.classList.remove('hidden');
      finalDiv.classList.add('hidden');
      return;
    }

    // Check if all elements exist before updating
    if (growthRawLabel) growthRawLabel.textContent = d.growthRaw + '/100';
    if (growthRawBar) growthRawBar.style.width = d.growthRaw + '%';
    if (growthAdjustedLabel) growthAdjustedLabel.textContent = d.growthAdjusted + '/100';
    if (growthAdjustedBar) growthAdjustedBar.style.width = d.growthAdjusted + '%';
    
    // Yield and disease
    if (yieldLbl) yieldLbl.textContent = d.yield + ' kg/ha';
    if (diseaseLbl) {
      diseaseLbl.textContent = d.diseaseLevel;
      diseaseLbl.className = `text-2xl font-bold ${d.diseaseLevel==='Low'?'text-green-600': d.diseaseLevel==='Medium'?'text-yellow-600':'text-red-600'}`;
    }
    if (riskScoreLbl) riskScoreLbl.textContent = `risk score ${d.diseaseScore}%`;
    
    // Soil and weather
    if (soilScoreLbl) soilScoreLbl.textContent = d.soilScore + '%';
    if (soilBar) soilBar.style.width = d.soilScore + '%';
    if (weatherScoreLbl) weatherScoreLbl.textContent = d.weatherScore + '%';
    if (weatherBar) weatherBar.style.width = d.weatherScore + '%';
    
    // Summary
    if (summaryLbl) summaryLbl.textContent = d.summary;
    
    // Sensitivity
    if (soilPercentLabel) soilPercentLabel.textContent = d.sensitivity.soil + '%';
    if (soilPercentBar) soilPercentBar.style.width = d.sensitivity.soil + '%';
    if (nutrientPercentLabel) nutrientPercentLabel.textContent = d.sensitivity.nutrient + '%';
    if (nutrientPercentBar) nutrientPercentBar.style.width = d.sensitivity.nutrient + '%';
    if (weatherPercentLabel) weatherPercentLabel.textContent = d.sensitivity.weather + '%';
    if (weatherPercentBar) weatherPercentBar.style.width = d.sensitivity.weather + '%';
    
    // Fertilizer
    const f = d.fertilizer;
    if (nStatusBadge) {
      nStatusBadge.textContent = f.nitrogenStatus;
      nStatusBadge.className = `status-badge status-${f.nitrogenStatus.toLowerCase()}`;
    }
    if (pStatusBadge) {
      pStatusBadge.textContent = f.phosphorusStatus;
      pStatusBadge.className = `status-badge status-${f.phosphorusStatus.toLowerCase()}`;
    }
    if (kStatusBadge) {
      kStatusBadge.textContent = f.potassiumStatus;
      kStatusBadge.className = `status-badge status-${f.potassiumStatus.toLowerCase()}`;
    }
    
    if (ureaDose) ureaDose.textContent = f.ureaKgPerHa;
    if (dapDose) dapDose.textContent = f.dapKgPerHa;
    if (mopDose) mopDose.textContent = f.mopKgPerHa;
    
    // Calculate efficiency factor
    const efficiency = Math.round((d.soilScore / 100) * 100);
    if (efficiencyFactor) efficiencyFactor.textContent = efficiency + '%';
    
    if (nitrogenMethodText) nitrogenMethodText.textContent = f.applicationMethod.nitrogen;
    if (phosphorusMethodText) phosphorusMethodText.textContent = f.applicationMethod.phosphorus;
    if (potassiumMethodText) potassiumMethodText.textContent = f.applicationMethod.potassium;
    
    // Warnings
    if (fertilizerWarnings) {
      fertilizerWarnings.innerHTML = '';
      d.warnings.forEach(w => {
        const warnEl = document.createElement('div');
        warnEl.className = 'text-xs p-2 bg-yellow-50 text-yellow-800 rounded border border-yellow-200';
        warnEl.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>${w}`;
        fertilizerWarnings.appendChild(warnEl);
      });
    }

    // Charts
    const compareCanvas = document.getElementById('compareChart');
    if (compareCanvas) {
      const ctxComp = compareCanvas.getContext('2d');
      if (charts.compare) charts.compare.destroy();
      charts.compare = new Chart(ctxComp, {
        type: 'bar', 
        data: { 
          labels: ['Raw Growth', 'Adjusted Growth', 'Soil', 'Weather'], 
          datasets: [{ 
            label: 'score', 
            data: [d.growthRaw, d.growthAdjusted, d.soilScore, d.weatherScore], 
            backgroundColor: ['#84cc16', '#16a34a', '#f59e0b', '#0ea5e9'] 
          }]
        },
        options: { 
          responsive: true, 
          plugins: { legend: { display: false } }, 
          scales: { y: { max: 100, beginAtZero: true } } 
        }
      });
    }

    const npkCanvas = document.getElementById('npkChart');
    if (npkCanvas) {
      const ctxNpk = npkCanvas.getContext('2d');
      if (charts.npk) charts.npk.destroy();
      charts.npk = new Chart(ctxNpk, {
        type: 'bar', 
        data: { 
          labels: ['N', 'P', 'K'], 
          datasets: [{ 
            label: 'kg per hectare', 
            data: [d.N, d.P, d.K], 
            backgroundColor: ['#15803d','#0ea5e9','#7c3aed'] 
          }]
        },
        options: { plugins: { legend: { display: false } } }
      });
    }

    finalDiv.classList.remove('hidden');
    setTimeout(() => finalDiv.classList.add('show'), 20);
  }

  // ========================================================
  // EVENT HANDLERS
  // ========================================================
  function allFilled() {
    return [districtEl.value, soilTexture.value, soilPh.value, soilMoisture.value, nitrogen.value, phosphorus.value, potassium.value, temperature.value, humidity.value, rainfall.value].every(v => v && v.toString().trim()!=='');
  }

  calcBtn.addEventListener('click', () => {
    warnBox.classList.add('hidden');
    if (!allFilled()) {
      warnText.textContent = 'âš  Please fill all fields (district, soil type and all numbers)';
      warnBox.classList.remove('hidden');
      placeholder.classList.remove('hidden');
      loader.classList.add('hidden');
      finalDiv.classList.add('hidden');
      return;
    }
    
    placeholder.classList.add('hidden');
    finalDiv.classList.add('hidden');
    loader.classList.remove('hidden');

    setTimeout(() => {
      const res = performAnalysis();
      loader.classList.add('hidden');
      renderResults(res);
    }, 1000);
  });

  districtEl.addEventListener('change', () => {
    const d = districtData.find(x => x.district === districtEl.value);
    if (!d) return;
    soilPh.value = d.pH;
    soilMoisture.value = d.moisture;
    nitrogen.value = d.nitrogen;
    phosphorus.value = d.phosphorus;
    potassium.value = d.potassium;
    temperature.value = d.temperature;
    humidity.value = d.humidity;
    rainfall.value = d.rainfall;
    soilTexture.value = '';
  });

  resetBtn.addEventListener('click', () => {
    document.getElementById('cropForm').reset();
    finalDiv.classList.add('hidden');
    finalDiv.classList.remove('show');
    loader.classList.add('hidden');
    placeholder.classList.remove('hidden');
    warnBox.classList.add('hidden');
    Object.values(charts).forEach(ch => { if(ch) ch.destroy(); });
    charts = { compare: null, npk: null };
  });

  function populateDiseaseTable() {
    const tbody = document.getElementById('diseaseTbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    diseaseData.forEach(d => {
      const tr = document.createElement('tr'); tr.className = 'disease-row';
      tr.innerHTML = `<td class="px-6 py-4 font-medium">${d.name}</td><td class="px-6 py-4 text-sm">${d.triggers}</td><td class="px-6 py-4 text-sm">${d.symptoms}</td><td class="px-6 py-4 text-sm">${d.prevention}</td>`;
      tbody.appendChild(tr);
    });
  }
  populateDiseaseTable();
  
  if (diseaseBtn) {
    diseaseBtn.addEventListener('click', () => diseaseModal.classList.remove('hidden'));
  }
  if (closeModal) {
    closeModal.addEventListener('click', () => diseaseModal.classList.add('hidden'));
  }

  if (viewDetails) {
    viewDetails.addEventListener('click', () => {
      if (fertDetails) {
        fertDetails.innerHTML = `
          <div class="bg-blue-50 p-4 rounded-lg">
            <h4 class="font-bold text-lg mb-2">ğŸ“Š Advanced Features Used:</h4>
            <ul class="list-disc pl-4 space-y-1 text-sm">
              <li>Safety caps: Urea â‰¤200, DAP â‰¤120, MOP â‰¤100 kg/ha</li>
              <li>Disease reduces growth (up to 50% reduction)</li>
              <li>Heat stress penalty: >35Â°C = 15% reduction, >38Â°C = 25%</li>
              <li>Lodging detection: High N + Low K adds risk</li>
              <li>Soil efficiency factor affects fertilizer response</li>
              <li>Rainfall weight reduced to avoid water double counting</li>
              <li>No forced minimum doses - only apply when needed</li>
            </ul>
          </div>
        `;
      }
      fertModal.classList.remove('hidden');
    });
  }

  if (closeFertModal) {
    closeFertModal.addEventListener('click', () => fertModal.classList.add('hidden'));
  }

  if (downloadBtn) {
    downloadBtn.addEventListener('click', () => {
      html2canvas(document.body, { scale: 1.5 }).then(canvas => {
        const link = document.createElement('a');
        link.download = `farmer_friend_${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      }).catch(console.warn);
    });
  }
})();
</script>
</body>
</html>